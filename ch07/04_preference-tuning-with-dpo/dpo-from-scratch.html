
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Direct Preference Optimization (DPO) for LLM Alignment (From Scratch) &#8212; LLMs from Scratch</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'ch07/04_preference-tuning-with-dpo/dpo-from-scratch';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Generating Datasets for Instruction Finetuning" href="../05_dataset-generation/README.html" />
    <link rel="prev" title="Generating A Preference Dataset With Llama 3.1 70B And Ollama" href="create-preference-data-ollama.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../README.html">
  
  
  
  
  
  
    <p class="title logo__title">LLMs from Scratch</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../README.html">
                    Build a Large Language Model (From Scratch)
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Setup</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../setup/README.html">Optional Setup Instructions</a></li>



</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapters</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../ch01/README.html">Chapter 1: Understanding Large Language Models</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../ch02/README.html">Chapter 2: Working with Text Data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch02/01_main-chapter-code/README.html">Chapter 2: Working with Text Data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch02/01_main-chapter-code/ch02.html">Chapter 2: Working with Text Data</a></li>

<li class="toctree-l3"><a class="reference internal" href="../../ch02/01_main-chapter-code/dataloader.html">The Main Data Loading Pipeline Summarized</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ch02/01_main-chapter-code/exercise-solutions.html">Chapter 2 Exercise solutions</a></li>


</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch02/02_bonus_bytepair-encoder/README.html">Chapter 2: Working with Text Data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch02/02_bonus_bytepair-encoder/compare-bpe-tiktoken.html">Comparing Various Byte Pair Encoding (BPE) Implementations</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch02/03_bonus_embedding-vs-matmul/README.html">Chapter 2: Working with Text Data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch02/03_bonus_embedding-vs-matmul/embeddings-and-linear-layers.html">Understanding the Difference Between Embedding Layers and Linear Layers</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch02/04_bonus_dataloader-intuition/README.html">Chapter 2: Working with Text Data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch02/04_bonus_dataloader-intuition/dataloader-intuition.html">Data sampling with a sliding window with number data</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch02/05_bpe-from-scratch/README.html">Byte Pair Encoding (BPE) Tokenizer From Scratch</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch02/05_bpe-from-scratch/bpe-from-scratch.html">Byte Pair Encoding (BPE) Tokenizer From Scratch</a></li>


</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../ch03/README.html">Chapter 3: Coding Attention Mechanisms</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch03/01_main-chapter-code/README.html">Chapter 3: Coding Attention Mechanisms</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch03/01_main-chapter-code/ch03.html">Chapter 3: Coding Attention Mechanisms</a></li>

<li class="toctree-l3"><a class="reference internal" href="../../ch03/01_main-chapter-code/multihead-attention.html">Multi-head Attention Plus Data Loading</a></li>

<li class="toctree-l3"><a class="reference internal" href="../../ch03/01_main-chapter-code/exercise-solutions.html">Chapter 3 Exercise solutions</a></li>



</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch03/02_bonus_efficient-multihead-attention/README.html">More Efficient Multi-Head Attention Implementations</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch03/02_bonus_efficient-multihead-attention/mha-implementations.html">Comparing Efficient Multi-Head Attention Implementations</a></li>

</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch03/03_understanding-buffers/README.html">Understanding PyTorch Buffers</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch03/03_understanding-buffers/understanding-buffers.html">Understanding PyTorch Buffers</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../ch04/README.html">Chapter 4: Implementing a GPT Model from Scratch to Generate Text</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch04/01_main-chapter-code/README.html">Chapter 4: Implementing a GPT Model from Scratch To Generate Text</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch04/01_main-chapter-code/ch04.html">Chapter 4: Implementing a GPT model from Scratch To Generate Text</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ch04/01_main-chapter-code/exercise-solutions.html">Chapter 4 Exercise solutions</a></li>



</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch04/02_performance-analysis/README.html">Chapter 4: Implementing a GPT Model from Scratch To Generate Text</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch04/02_performance-analysis/flops-analysis.html">FLOPS Analysis</a></li>



</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../ch05/README.html">Chapter 5: Pretraining on Unlabeled Data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch05/01_main-chapter-code/README.html">Chapter 5: Pretraining on Unlabeled Data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch05/01_main-chapter-code/ch05.html">Chapter 5: Pretraining on Unlabeled Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ch05/01_main-chapter-code/exercise-solutions.html">Chapter 5 Exercise solutions</a></li>






</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch05/02_alternative_weight_loading/README.html">Alternative Approaches to Loading Pretrained Weights</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch05/02_alternative_weight_loading/weight-loading-hf-safetensors.html">Bonus Code for Chapter 5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ch05/02_alternative_weight_loading/weight-loading-hf-transformers.html">Bonus Code for Chapter 5</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ch05/02_alternative_weight_loading/weight-loading-pytorch.html">Bonus Code for Chapter 5</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../ch05/03_bonus_pretraining_on_gutenberg/README.html">Pretraining GPT on the Project Gutenberg Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ch05/04_learning_rate_schedulers/README.html">Adding Bells and Whistles to the Training Loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ch05/05_bonus_hparam_tuning/README.html">Optimizing Hyperparameters for Pretraining</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ch05/06_user_interface/README.html">Building a User Interface to Interact With the Pretrained LLM</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch05/07_gpt_to_llama/README.html">Converting GPT to Llama</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch05/07_gpt_to_llama/converting-gpt-to-llama2.html">Converting a From-Scratch GPT Architecture to Llama 2</a></li>


<li class="toctree-l3"><a class="reference internal" href="../../ch05/07_gpt_to_llama/converting-llama2-to-llama3.html">Converting Llama 2 to Llama 3.2 From Scratch</a></li>




<li class="toctree-l3"><a class="reference internal" href="../../ch05/07_gpt_to_llama/standalone-llama32.html">Llama 3.2 From Scratch (A Standalone Notebook)</a></li>






<li class="toctree-l3"><a class="reference internal" href="../../ch05/07_gpt_to_llama/standalone-llama32-mem-opt.html">Llama 3.2 From Scratch (A Standalone Notebook)</a></li>






</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch05/08_memory_efficient_weight_loading/README.html">Memory-efficient Model Weight Loading</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch05/08_memory_efficient_weight_loading/memory-efficient-state-dict.html">Memory-efficient Model Weight Loading</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch05/09_extending-tokenizers/README.html">Extending the Tiktoken BPE Tokenizer with New Tokens</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch05/09_extending-tokenizers/extend-tiktoken.html">Extending the Tiktoken BPE Tokenizer with New Tokens</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../ch05/10_llm-training-speed/README.html">PyTorch Performance Tips for Faster LLM Training</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../ch06/README.html">Chapter 6: Finetuning for Classification</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch06/01_main-chapter-code/README.html">Chapter 6: Finetuning for Classification</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch06/01_main-chapter-code/ch06.html">Chapter 6: Finetuning for Text Classification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ch06/01_main-chapter-code/load-finetuned-model.html">Load And Use Finetuned Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../ch06/01_main-chapter-code/exercise-solutions.html">Chapter 6 Exercise solutions</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../ch06/02_bonus_additional-experiments/README.html">Additional Classification Finetuning Experiments</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ch06/03_bonus_imdb-classification/README.html">Additional Experiments Classifying the Sentiment of 50k IMDB Movie Reviews</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ch06/03_bonus_imdb-classification/sklearn-baseline.html">Scikit-learn Logistic Regression Model</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../ch06/04_user_interface/README.html">Building a User Interface to Interact With the GPT-based Spam Classifier</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../README.html">Chapter 7: Finetuning to Follow Instructions</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 has-children"><a class="reference internal" href="../01_main-chapter-code/README.html">Chapter 7: Finetuning to Follow Instructions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../01_main-chapter-code/ch07.html">Chapter 7: Finetuning To Follow Instructions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../01_main-chapter-code/load-finetuned-model.html">Load And Use Finetuned Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../01_main-chapter-code/exercise-solutions.html">Chapter 7 Exercise solutions</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../02_dataset-utilities/README.html">Chapter 7: Finetuning to Follow Instructions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../02_dataset-utilities/create-passive-voice-entries.html">Create “Passive Voice” Entries for an Instruction Dataset</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../03_model-evaluation/README.html">Chapter 7: Finetuning to Follow Instructions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../03_model-evaluation/llm-instruction-eval-ollama.html">Evaluating Instruction Responses Locally Using a Llama 3 Model Via Ollama</a></li>
<li class="toctree-l3"><a class="reference internal" href="../03_model-evaluation/llm-instruction-eval-openai.html">Evaluating Instruction Responses Using the OpenAI API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../03_model-evaluation/scores/correlation-analysis.html">Score Correlation Analysis</a></li>
</ul>
</details></li>
<li class="toctree-l2 current active has-children"><a class="reference internal" href="README.html">Chapter 7: Finetuning to Follow Instructions</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="create-preference-data-ollama.html">Generating A Preference Dataset With Llama 3.1 70B And Ollama</a></li>
<li class="toctree-l3 current active"><a class="current reference internal" href="#">Direct Preference Optimization (DPO) for LLM Alignment (From Scratch)</a></li>






</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../05_dataset-generation/README.html">Generating Datasets for Instruction Finetuning</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../05_dataset-generation/llama3-ollama.html">Generating An Instruction Dataset via Llama 3 and Ollama</a></li>
<li class="toctree-l3"><a class="reference internal" href="../05_dataset-generation/reflection-gpt4.html">Improving Instruction-Data Via Reflection-Tuning Using GPT-4</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../06_user_interface/README.html">Building a User Interface to Interact With the Instruction Finetuned GPT Model</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../appendix-A/README.html">Appendix A: Introduction to PyTorch</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../appendix-A/01_main-chapter-code/README.html">Appendix A: Introduction to PyTorch</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../../appendix-A/01_main-chapter-code/code-part1.html">Appendix A: Introduction to PyTorch (Part 1)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../appendix-A/01_main-chapter-code/code-part2.html">Appendix A: Introduction to PyTorch (Part 2)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../appendix-A/01_main-chapter-code/exercise-solutions.html">Exercise A.1</a></li>



</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../../appendix-A/02_setup-recommendations/README.html">Python and Environment Setup Recommendations</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../appendix-D/README.html">Appendix D: Adding Bells and Whistles to the Training Loop</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../appendix-D/01_main-chapter-code/appendix-D.html">Appendix D: Adding Bells and Whistles to the Training Loop</a></li>




</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../appendix-E/README.html">Appendix E: Parameter-efficient Finetuning with LoRA</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../appendix-E/01_main-chapter-code/appendix-E.html">Appendix E: Parameter-efficient Finetuning with LoRA</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/rasbt/llms-from-scratch/main?urlpath=lab/tree/ch07/04_preference-tuning-with-dpo/dpo-from-scratch.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/rasbt/llms-from-scratch/blob/main/ch07/04_preference-tuning-with-dpo/dpo-from-scratch.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/rasbt/llms-from-scratch" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/rasbt/llms-from-scratch/edit/main/ch07/04_preference-tuning-with-dpo/dpo-from-scratch.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/rasbt/llms-from-scratch/issues/new?title=Issue%20on%20page%20%2Fch07/04_preference-tuning-with-dpo/dpo-from-scratch.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/ch07/04_preference-tuning-with-dpo/dpo-from-scratch.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Direct Preference Optimization (DPO) for LLM Alignment (From Scratch)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Direct Preference Optimization (DPO) for LLM Alignment (From Scratch)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#a-brief-introduction-to-dpo">1) A brief introduction to DPO</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-a-preference-dataset-for-dpo">2) Preparing a preference dataset for DPO</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-a-preference-dataset">2.1) Loading a preference dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-training-validation-and-test-splits">2.2) Creating training, validation, and test splits</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#developing-a-preferencedataset-class-and-batch-processing-function">2.3) Developing a <code class="docutils literal notranslate"><span class="pre">PreferenceDataset</span></code> class and batch processing function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-training-validation-and-test-set-data-loaders">2.4) Creating training, validation, and test set data loaders</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-a-finetuned-llm-for-dpo-alignment">3) Loading a finetuned LLM for DPO alignment</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#coding-the-dpo-loss-function">4) Coding the DPO Loss Function</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#training-the-model">5) Training the model</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#analyzing-the-results">6) Analyzing the results</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <table style="width:100%">
<tr>
<td style="vertical-align:middle; text-align:left;">
<font size="2">
Supplementary code for the <a href="http://mng.bz/orYv">Build a Large Language Model From Scratch</a> book by <a href="https://sebastianraschka.com">Sebastian Raschka</a><br>
<br>Code repository: <a href="https://github.com/rasbt/LLMs-from-scratch">https://github.com/rasbt/LLMs-from-scratch</a>
</font>
</td>
<td style="vertical-align:middle; text-align:left;">
<a href="http://mng.bz/orYv"><img src="https://sebastianraschka.com/images/LLMs-from-scratch-images/cover-small.webp" width="100px"></a>
</td>
</tr>
</table><section class="tex2jax_ignore mathjax_ignore" id="direct-preference-optimization-dpo-for-llm-alignment-from-scratch">
<h1>Direct Preference Optimization (DPO) for LLM Alignment (From Scratch)<a class="headerlink" href="#direct-preference-optimization-dpo-for-llm-alignment-from-scratch" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>This code notebook implements Direct Preference Optimization (DPO) from scratch and applies it to a large language model (LLM) to enhance its ability to generate responses that align more closely with user preferences</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !pip install -r https://raw.githubusercontent.com/rasbt/LLMs-from-scratch/main/requirements.txt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">importlib.metadata</span><span class="w"> </span><span class="kn">import</span> <span class="n">version</span>

<span class="n">pkgs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;tiktoken&quot;</span><span class="p">,</span>    <span class="c1"># Tokenizer</span>
    <span class="s2">&quot;torch&quot;</span><span class="p">,</span>       <span class="c1"># Deep learning library</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> version: </span><span class="si">{</span><span class="n">version</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">PackageNotFoundError</span><span class="g g-Whitespace">                      </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">8</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">pkgs</span> <span class="o">=</span> <span class="p">[</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="s2">&quot;tiktoken&quot;</span><span class="p">,</span>    <span class="c1"># Tokenizer</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="s2">&quot;torch&quot;</span><span class="p">,</span>       <span class="c1"># Deep learning library</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pkgs</span><span class="p">:</span>
<span class="ne">----&gt; </span><span class="mi">8</span>     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> version: </span><span class="si">{</span><span class="n">version</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nn">File /Library/Frameworks/Python.framework/Versions/3.10/lib/python3.10/importlib/metadata/__init__.py:946,</span> in <span class="ni">version</span><span class="nt">(distribution_name)</span>
<span class="g g-Whitespace">    </span><span class="mi">939</span> <span class="k">def</span><span class="w"> </span><span class="nf">version</span><span class="p">(</span><span class="n">distribution_name</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">940</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Get the version string for the named package.</span>
<span class="g g-Whitespace">    </span><span class="mi">941</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">942</span><span class="sd">     :param distribution_name: The name of the distribution package to query.</span>
<span class="g g-Whitespace">    </span><span class="mi">943</span><span class="sd">     :return: The version string for the package as defined in the package&#39;s</span>
<span class="g g-Whitespace">    </span><span class="mi">944</span><span class="sd">         &quot;Version&quot; metadata key.</span>
<span class="g g-Whitespace">    </span><span class="mi">945</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">946</span>     <span class="k">return</span> <span class="n">distribution</span><span class="p">(</span><span class="n">distribution_name</span><span class="p">)</span><span class="o">.</span><span class="n">version</span>

<span class="nn">File /Library/Frameworks/Python.framework/Versions/3.10/lib/python3.10/importlib/metadata/__init__.py:919,</span> in <span class="ni">distribution</span><span class="nt">(distribution_name)</span>
<span class="g g-Whitespace">    </span><span class="mi">913</span> <span class="k">def</span><span class="w"> </span><span class="nf">distribution</span><span class="p">(</span><span class="n">distribution_name</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">914</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Get the ``Distribution`` instance for the named package.</span>
<span class="g g-Whitespace">    </span><span class="mi">915</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">916</span><span class="sd">     :param distribution_name: The name of the distribution package as a string.</span>
<span class="g g-Whitespace">    </span><span class="mi">917</span><span class="sd">     :return: A ``Distribution`` instance (or subclass thereof).</span>
<span class="g g-Whitespace">    </span><span class="mi">918</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">919</span>     <span class="k">return</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">distribution_name</span><span class="p">)</span>

<span class="nn">File /Library/Frameworks/Python.framework/Versions/3.10/lib/python3.10/importlib/metadata/__init__.py:518,</span> in <span class="ni">Distribution.from_name</span><span class="nt">(cls, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">516</span>         <span class="k">return</span> <span class="n">dist</span>
<span class="g g-Whitespace">    </span><span class="mi">517</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">518</span>     <span class="k">raise</span> <span class="n">PackageNotFoundError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="ne">PackageNotFoundError</span>: No package metadata was found for tiktoken
</pre></div>
</div>
</div>
</div>
<p> </p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="a-brief-introduction-to-dpo">
<h1>1) A brief introduction to DPO<a class="headerlink" href="#a-brief-introduction-to-dpo" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>DPO, proposed in the paper <a class="reference external" href="https://arxiv.org/abs/2305.18290">Direct Preference Optimization: Your Language Model is Secretly a Reward Model</a>, is an alternative to reinforcement learning from human feedback (RLHF) used in finetuning large language models (LLMs)</p></li>
<li><p>DPO can be used to finetune (or align) the model to generate responses that better align with user expectations and instructions</p></li>
</ul>
<img src="https://sebastianraschka.com/images/LLMs-from-scratch-images/dpo/1.webp" width=500px>
<ul class="simple">
<li><p>In instruction finetuning, we train the LLM to generate correct answers given a prompt</p></li>
<li><p>However, in practice, there are multiple ways to give a correct answer, and correct answers can differ in style; for example, consider a technical and a more user-friendly response when asking an LLM to give recommendations when buying a laptop, as shown in the figure below</p></li>
</ul>
<img src="https://sebastianraschka.com/images/LLMs-from-scratch-images/dpo/2.webp" width=700px>
<ul class="simple">
<li><p>RLHF and DPO are methods that can be used to teach the LLM to prefer one answer style over the other, that is, aligning better with user preferences</p></li>
<li><p>The RLHF process, which requires training a separate reward model, is outlined below</p></li>
</ul>
<img src="https://sebastianraschka.com/images/LLMs-from-scratch-images/dpo/4.webp" width=600px><ul class="simple">
<li><p>Compared to RLHF, DPO aims to simplify the process by optimizing models directly for user preferences without the need for complex reward modeling and policy optimization</p></li>
<li><p>In other words, DPO focuses on directly optimizing the model’s output to align with human preferences or specific objectives</p></li>
<li><p>Shown below is the main idea as an overview of how DPO works</p></li>
</ul>
<img src="https://sebastianraschka.com/images/LLMs-from-scratch-images/dpo/5.webp?123" width=600px><ul class="simple">
<li><p>The concrete equation to implement the DPO loss is shown below; we will revisit the equation when we implement it in Python further down in this code notebook</p></li>
</ul>
<img src="https://sebastianraschka.com/images/LLMs-from-scratch-images/dpo/3.webp?123" width=600px><ul class="simple">
<li><p>In the equation above,</p>
<ul>
<li><p>“expected value” <span class="math notranslate nohighlight">\(\mathbb{E}\)</span> is statistics jargon and stands for the average or mean value of the random variable (the expression inside the brackets); optimizing <span class="math notranslate nohighlight">\(-\mathbb{E}\)</span> aligns the model better with user preferences</p></li>
<li><p>The <span class="math notranslate nohighlight">\(\pi_{\theta}\)</span> variable is the so-called policy (a term borrowed from reinforcement learning) and represents the LLM we want to optimize; <span class="math notranslate nohighlight">\(\pi_{ref}\)</span> is a reference LLM, which is typically the original LLM before optimization (at the beginning of the training, <span class="math notranslate nohighlight">\(\pi_{\theta}\)</span> and <span class="math notranslate nohighlight">\(\pi_{ref}\)</span> are typically the same)</p></li>
<li><p><span class="math notranslate nohighlight">\(\beta\)</span> is a hyperparameter to control the divergence between the <span class="math notranslate nohighlight">\(\pi_{\theta}\)</span> and the reference model; increasing <span class="math notranslate nohighlight">\(\beta\)</span> increases the impact of the difference between
<span class="math notranslate nohighlight">\(\pi_{\theta}\)</span> and <span class="math notranslate nohighlight">\(\pi_{ref}\)</span> in terms of their log probabilities on the overall loss function, thereby increasing the divergence between the two models</p></li>
<li><p>the logistic sigmoid function, <span class="math notranslate nohighlight">\(\sigma(\centerdot)\)</span> transforms the log-odds of the preferred and rejected responses (the terms inside the logistic sigmoid function) into a probability score</p></li>
</ul>
</li>
<li><p>To avoid bloating the code notebook with a more detailed discussion, I may write a separate standalone article with more details on these concepts in the future</p></li>
<li><p>In the meantime, if you are interested in comparing RLHF and DPO, please see the section <a class="reference external" href="https://magazine.sebastianraschka.com/i/142924793/rlhf-vs-direct-preference-optimization-dpo">2.2. RLHF vs Direct Preference Optimization (DPO)</a> in my article <a class="reference external" href="https://magazine.sebastianraschka.com/p/tips-for-llm-pretraining-and-evaluating-rms">Tips for LLM Pretraining and Evaluating Reward Models</a></p></li>
</ul>
<p> </p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="preparing-a-preference-dataset-for-dpo">
<h1>2) Preparing a preference dataset for DPO<a class="headerlink" href="#preparing-a-preference-dataset-for-dpo" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Let’s begin by loading and preparing the dataset, which may already answer a lot of the questions you might have before we revisit the DPO loss equation</p></li>
<li><p>Here, we work with a dataset that contains more polite and less polite responses to instruction prompts (concrete examples are shown in the next section)</p></li>
<li><p>The dataset was generated via the <a class="reference internal" href="create-preference-data-ollama.html"><span class="std std-doc">create-preference-data-ollama.ipynb</span></a> notebook</p></li>
</ul>
<p> </p>
<section id="loading-a-preference-dataset">
<h2>2.1) Loading a preference dataset<a class="headerlink" href="#loading-a-preference-dataset" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>The dataset is a json file with 1100 entries:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download_and_load_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">text_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">text_data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;instruction-data-with-preference.json&quot;</span>
<span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;https://raw.githubusercontent.com/rasbt/LLMs-from-scratch&quot;</span>
    <span class="s2">&quot;/main/ch07/04_preference-tuning-with-dpo/instruction-data-with-preference.json&quot;</span>
<span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">download_and_load_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of entries:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of entries: 1100
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Let’s take a look at two example entries:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pprint</span>

<span class="n">pprint</span><span class="o">.</span><span class="n">pp</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">50</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;instruction&#39;: &#39;Identify the correct spelling of the following word.&#39;,
 &#39;input&#39;: &#39;Ocassion&#39;,
 &#39;output&#39;: &quot;The correct spelling is &#39;Occasion.&#39;&quot;,
 &#39;rejected&#39;: &quot;The correct spelling is obviously &#39;Occasion.&#39;&quot;,
 &#39;chosen&#39;: &quot;The correct spelling is &#39;Occasion.&#39;&quot;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="o">.</span><span class="n">pp</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">999</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;instruction&#39;: &quot;What is an antonym of &#39;complicated&#39;?&quot;,
 &#39;input&#39;: &#39;&#39;,
 &#39;output&#39;: &quot;An antonym of &#39;complicated&#39; is &#39;simple&#39;.&quot;,
 &#39;chosen&#39;: &quot;A suitable antonym for &#39;complicated&#39; would be &#39;simple&#39;.&quot;,
 &#39;rejected&#39;: &quot;An antonym of &#39;complicated&#39; is &#39;simple&#39;.&quot;}
</pre></div>
</div>
</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is formatted as code</span>
</pre></div>
</div>
<ul class="simple">
<li><p>As we can see above, the dataset consists of 5 keys:</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">'instruction'</span></code> and <code class="docutils literal notranslate"><span class="pre">'input'</span></code> that are used as LLM inputs</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">'output'</span></code> contains the response the model was trained on via the instruction finetuning step in chapter 7</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">'chosen'</span></code> and <code class="docutils literal notranslate"><span class="pre">'rejected'</span></code> entries are the entries we use for DPO; here <code class="docutils literal notranslate"><span class="pre">'chosen'</span></code> is the preferred response, and <code class="docutils literal notranslate"><span class="pre">'rejected'</span></code> is the dispreferred response</p></li>
</ul>
</li>
<li><p>The goal is to get the model to follow the style of the chosen over the rejected responses</p></li>
</ul>
<ul class="simple">
<li><p>Below is a utility function that formats the model input by applying the Alpaca prompt style similar to chapter 7 (<a class="reference internal" href="../01_main-chapter-code/ch07.html"><span class="std std-doc">../01_main-chapter-code/ch07.ipynb</span></a>):</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">format_input</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
    <span class="n">instruction_text</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Below is an instruction that describes a task. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Write a response that appropriately completes the request.&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">### Instruction:</span><span class="se">\n</span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;instruction&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">input_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">### Input:</span><span class="se">\n</span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">return</span> <span class="n">instruction_text</span> <span class="o">+</span> <span class="n">input_text</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_input</span> <span class="o">=</span> <span class="n">format_input</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">50</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model_input</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Identify the correct spelling of the following word.

### Input:
Ocassion
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Similarly, we can format the chosen and rejected responses using the Alpaca prompt style:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">desired_response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;### Response:</span><span class="se">\n</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="mi">50</span><span class="p">][</span><span class="s1">&#39;chosen&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">desired_response</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>### Response:
The correct spelling is &#39;Occasion.&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">possible_response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;### Response:</span><span class="se">\n</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="mi">50</span><span class="p">][</span><span class="s1">&#39;rejected&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">possible_response</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>### Response:
The correct spelling is obviously &#39;Occasion.&#39;
</pre></div>
</div>
</div>
</div>
<p> </p>
</section>
<section id="creating-training-validation-and-test-splits">
<h2>2.2) Creating training, validation, and test splits<a class="headerlink" href="#creating-training-validation-and-test-splits" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Next, we divide the dataset into 3 subsets, 85% training data, 5% validation data, and 10% test data:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_portion</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.85</span><span class="p">)</span>  <span class="c1"># 85% for training</span>
<span class="n">test_portion</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>    <span class="c1"># 10% for testing</span>
<span class="n">val_portion</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_portion</span> <span class="o">-</span> <span class="n">test_portion</span>  <span class="c1"># Remaining 5% for validation</span>

<span class="n">train_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">train_portion</span><span class="p">]</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">train_portion</span><span class="p">:</span><span class="n">train_portion</span> <span class="o">+</span> <span class="n">test_portion</span><span class="p">]</span>
<span class="n">val_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">train_portion</span> <span class="o">+</span> <span class="n">test_portion</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training set length:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Validation set length:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test set length:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training set length: 935
Validation set length: 55
Test set length: 110
</pre></div>
</div>
</div>
</div>
<p> </p>
</section>
<section id="developing-a-preferencedataset-class-and-batch-processing-function">
<h2>2.3) Developing a <code class="docutils literal notranslate"><span class="pre">PreferenceDataset</span></code> class and batch processing function<a class="headerlink" href="#developing-a-preferencedataset-class-and-batch-processing-function" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>In this section, we rewrite the <code class="docutils literal notranslate"><span class="pre">InstructionDataset</span></code> class from chapter 7 (<a class="reference internal" href="../01_main-chapter-code/ch07.html"><span class="std std-doc">../01_main-chapter-code/ch07.ipynb</span></a>) for DPO</p></li>
<li><p>This means that instead of focusing on single output sequences (responses), we modify the dataset class to return pairs of responses where one is preferred (“chosen”) over the other (“rejected”)</p></li>
<li><p>Overall, the <code class="docutils literal notranslate"><span class="pre">PreferenceDataset</span></code> is almost identical to the <code class="docutils literal notranslate"><span class="pre">InstructionDataset</span></code> used in chapter 7:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PreferenceDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># Pre-tokenize texts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoded_texts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">format_input</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="n">rejected_response</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">]</span>
            <span class="n">chosen_response</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">]</span>

            <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="n">chosen_full_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">### Response:</span><span class="se">\n</span><span class="si">{</span><span class="n">chosen_response</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">rejected_full_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">### Response:</span><span class="se">\n</span><span class="si">{</span><span class="n">rejected_response</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">chosen_full_tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">chosen_full_text</span><span class="p">)</span>
            <span class="n">rejected_full_tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">rejected_full_text</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">encoded_texts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">prompt_tokens</span><span class="p">,</span>
                <span class="s2">&quot;chosen&quot;</span><span class="p">:</span> <span class="n">chosen_full_tokens</span><span class="p">,</span>
                <span class="s2">&quot;rejected&quot;</span><span class="p">:</span> <span class="n">rejected_full_tokens</span><span class="p">,</span>
            <span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoded_texts</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Along with an updated <code class="docutils literal notranslate"><span class="pre">PreferenceDataset</span></code> class, we also need an updated batch collation function that we use to pad the sequences in each batch to an equal length so that we can assemble them in batches</p></li>
<li><p>I added comments to the code below to illustrate the process; however, it might be easiest to understand how it works by looking at the example inputs and outputs further below:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">custom_collate_fn</span><span class="p">(</span>
    <span class="n">batch</span><span class="p">,</span>
    <span class="n">pad_token_id</span><span class="o">=</span><span class="mi">50256</span><span class="p">,</span>
    <span class="n">allowed_max_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mask_prompt_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span>
<span class="p">):</span>
    <span class="c1"># Initialize lists to hold batch data</span>
    <span class="n">batch_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;chosen&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;rejected&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;rejected_mask&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;chosen_mask&quot;</span><span class="p">:</span> <span class="p">[]</span>

    <span class="p">}</span>

    <span class="c1"># Determine the longest sequence to set a common padding length</span>
    <span class="n">max_length_common</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">batch</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected&quot;</span><span class="p">]:</span>
            <span class="n">current_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">)</span>
            <span class="n">max_length_common</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_length_common</span><span class="p">,</span> <span class="n">current_max</span><span class="p">)</span>

    <span class="c1"># Process each item in the batch</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">])</span>
        <span class="n">batch_data</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected&quot;</span><span class="p">]:</span>
            <span class="c1"># Adjust padding according to the common maximum length</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">padded</span> <span class="o">=</span> <span class="n">sequence</span> <span class="o">+</span> <span class="p">[</span><span class="n">pad_token_id</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_length_common</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">))</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">padded</span><span class="p">))</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>

            <span class="c1"># Set mask for all padding tokens to False</span>
            <span class="n">mask</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">):]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Set mask for all input tokens to False</span>
            <span class="c1"># +2 sets the 2 newline (&quot;\n&quot;) tokens before &quot;### Response&quot; to False</span>
            <span class="k">if</span> <span class="n">mask_prompt_tokens</span><span class="p">:</span>
                <span class="n">mask</span><span class="p">[:</span><span class="n">prompt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">batch_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">padded</span><span class="p">))</span>
            <span class="n">batch_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="c1"># Final processing</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;chosen_mask&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected_mask&quot;</span><span class="p">]:</span>
        <span class="c1"># Stack all sequences into a tensor for the given key</span>
        <span class="n">tensor_stack</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="c1"># Optionally truncate to maximum sequence length</span>
        <span class="k">if</span> <span class="n">allowed_max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tensor_stack</span> <span class="o">=</span> <span class="n">tensor_stack</span><span class="p">[:,</span> <span class="p">:</span><span class="n">allowed_max_length</span><span class="p">]</span>

        <span class="c1"># Move to the specified device</span>
        <span class="n">batch_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensor_stack</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">batch_data</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Before we start using the custom collate function, let’s make version of it with some of its function arguments prefilled:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Device:&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

<span class="n">customized_collate_fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
    <span class="n">custom_collate_fn</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>            <span class="c1"># Put the data directly on a GPU if available</span>
    <span class="n">mask_prompt_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># This is optional</span>
    <span class="n">allowed_max_length</span><span class="o">=</span><span class="mi">1024</span>   <span class="c1"># The supported context length of the model</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Device: cuda
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Now, let’s see the <code class="docutils literal notranslate"><span class="pre">customized_collate_fn</span></code> in action and apply it to some sample data from our preference dataset; for this, we take the first two entries:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">example_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">example_data</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="n">pprint</span><span class="o">.</span><span class="n">pp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;instruction&#39;: &#39;Evaluate the following phrase by transforming it into the &#39;
                &#39;spelling given.&#39;,
 &#39;input&#39;: &#39;freind --&gt; friend&#39;,
 &#39;output&#39;: &#39;The spelling of the given phrase &quot;freind&quot; is incorrect, the &#39;
           &#39;correct spelling is &quot;friend&quot;.&#39;,
 &#39;rejected&#39;: &#39;The spelling of the given phrase &quot;freind&quot; is flat out wrong, get &#39;
             &#39;it together, the correct spelling is &quot;friend&quot;.&#39;,
 &#39;chosen&#39;: &#39;The spelling of the given phrase &quot;freind&quot; is incorrect, the &#39;
           &#39;correct spelling is &quot;friend&quot;.&#39;}

{&#39;instruction&#39;: &#39;Edit the following sentence for grammar.&#39;,
 &#39;input&#39;: &#39;He go to the park every day.&#39;,
 &#39;output&#39;: &#39;He goes to the park every day.&#39;,
 &#39;rejected&#39;: &#39;He goes to the stupid park every single day.&#39;,
 &#39;chosen&#39;: &#39;He goes to the park every day.&#39;}
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Next, let’s instantiate an <code class="docutils literal notranslate"><span class="pre">example_dataset</span></code> and use a PyTorch <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> to create an <code class="docutils literal notranslate"><span class="pre">example_dataloader</span></code> that mimics the data loader we will use for the model training later:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tiktoken</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>


<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">get_encoding</span><span class="p">(</span><span class="s2">&quot;gpt2&quot;</span><span class="p">)</span>

<span class="n">example_dataset</span> <span class="o">=</span> <span class="n">PreferenceDataset</span><span class="p">(</span><span class="n">example_data</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>

<span class="n">example_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">example_dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">collate_fn</span><span class="o">=</span><span class="n">customized_collate_fn</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The dataset has the following keys:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">example_dataloader</span><span class="p">:</span>
    <span class="k">break</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;batch.keys:&quot;</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>batch.keys: dict_keys([&#39;prompt&#39;, &#39;chosen&#39;, &#39;rejected&#39;, &#39;rejected_mask&#39;, &#39;chosen_mask&#39;])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The prompts are a list of tensors, where each tensor contains the token IDs for a given example; since we selected a batch size of 2, we have two lists of token ID tensors here:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[tensor([21106,   318,   281, 12064,   326,  8477,   257,  4876,    13, 19430,
           257,  2882,   326, 20431, 32543,   262,  2581,    13,   198,   198,
         21017, 46486,    25,   198,    36,  2100,  4985,   262,  1708,  9546,
           416, 25449,   340,   656,   262, 24993,  1813,    13,   198,   198,
         21017, 23412,    25,   198, 19503,   521, 14610,  1545]),
 tensor([21106,   318,   281, 12064,   326,  8477,   257,  4876,    13, 19430,
           257,  2882,   326, 20431, 32543,   262,  2581,    13,   198,   198,
         21017, 46486,    25,   198, 18378,   262,  1708,  6827,   329, 23491,
            13,   198,   198, 21017, 23412,    25,   198,  1544,   467,   284,
           262,  3952,   790,  1110,    13])]
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We don’t really need the responses for training; what we need to feed to the model during training are the <code class="docutils literal notranslate"><span class="pre">&quot;chosen&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;rejected&quot;</span></code> entries</p></li>
<li><p>The  <code class="docutils literal notranslate"><span class="pre">&quot;chosen&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;rejected&quot;</span></code> response entries are padded so that we can stack them as tensors; similar to the prompts, these response texts are encoded into token IDs:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor([[21106,   318,   281, 12064,   326,  8477,   257,  4876,    13, 19430,
           257,  2882,   326, 20431, 32543,   262,  2581,    13,   198,   198,
         21017, 46486,    25,   198,    36,  2100,  4985,   262,  1708,  9546,
           416, 25449,   340,   656,   262, 24993,  1813,    13,   198,   198,
         21017, 23412,    25,   198, 19503,   521, 14610,  1545,   198,   198,
         21017, 18261,    25,   198,   464, 24993,   286,   262,  1813,  9546,
           366, 19503,   521,     1,   318, 11491,    11,   262,  3376, 24993,
           318,   366,  6726,  1911, 50256, 50256, 50256, 50256, 50256, 50256,
         50256],
        [21106,   318,   281, 12064,   326,  8477,   257,  4876,    13, 19430,
           257,  2882,   326, 20431, 32543,   262,  2581,    13,   198,   198,
         21017, 46486,    25,   198, 18378,   262,  1708,  6827,   329, 23491,
            13,   198,   198, 21017, 23412,    25,   198,  1544,   467,   284,
           262,  3952,   790,  1110,    13,   198,   198, 21017, 18261,    25,
           198,  1544,  2925,   284,   262,  3952,   790,  1110,    13, 50256,
         50256, 50256, 50256, 50256, 50256, 50256, 50256, 50256, 50256, 50256,
         50256, 50256, 50256, 50256, 50256, 50256, 50256, 50256, 50256, 50256,
         50256]], device=&#39;cuda:0&#39;)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The token IDs above represent the model inputs, but in this format, they are hard to interpret for us humans</p></li>
<li><p>So, let’s implement a small utility function to convert them back into text so that we can inspect and interpret them more easily:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">decode_tokens_from_batch</span><span class="p">(</span><span class="n">token_ids</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
    <span class="n">ids_in_python_list</span> <span class="o">=</span> <span class="n">token_ids</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">ids_in_python_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Let’s apply the <code class="docutils literal notranslate"><span class="pre">decode_tokens_from_batch</span></code> utility function to the first prompt entry in the batch:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="n">decode_tokens_from_batch</span><span class="p">(</span>
    <span class="n">token_ids</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># [0] for the first entry in the batch</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Evaluate the following phrase by transforming it into the spelling given.

### Input:
freind --&gt; friend
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>As we can see above, the prompt was correctly formatted; let’s now do the same for the <code class="docutils literal notranslate"><span class="pre">&quot;chosen&quot;</span></code> response:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="n">decode_tokens_from_batch</span><span class="p">(</span>
    <span class="n">token_ids</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Evaluate the following phrase by transforming it into the spelling given.

### Input:
freind --&gt; friend

### Response:
The spelling of the given phrase &quot;freind&quot; is incorrect, the correct spelling is &quot;friend&quot;.&lt;|endoftext|&gt;&lt;|endoftext|&gt;&lt;|endoftext|&gt;&lt;|endoftext|&gt;&lt;|endoftext|&gt;&lt;|endoftext|&gt;&lt;|endoftext|&gt;
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>As we can see above, similar to instruction finetuning, the response that is passed to the model during training also contains the input prompt</p></li>
<li><p>Also note that we included <code class="docutils literal notranslate"><span class="pre">&lt;|endoftext|&gt;</span></code> tokens as padding tokens, which are necessary so that we can extend the responses to a similar length to stack them as a batch</p></li>
<li><p>Don’t worry; the <code class="docutils literal notranslate"><span class="pre">&lt;|endoftext|&gt;</span></code> tokens will be ignored in the loss later so that they won’t affect the training outcome</p></li>
<li><p>Let’s now also inspect the corresponding rejected response:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="n">decode_tokens_from_batch</span><span class="p">(</span>
    <span class="n">token_ids</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Evaluate the following phrase by transforming it into the spelling given.

### Input:
freind --&gt; friend

### Response:
The spelling of the given phrase &quot;freind&quot; is flat out wrong, get it together, the correct spelling is &quot;friend&quot;.&lt;|endoftext|&gt;
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>In this case, as we can see above, the rejected response is a more impolite version of the chosen response (we don’t want the model to generate impolite responses)</p></li>
<li><p>Lastly, let’s talk about the data masks: if you took a closer look at our custom collate function we implemented above, we created a <code class="docutils literal notranslate"><span class="pre">&quot;chosen_mask&quot;</span></code> and a <code class="docutils literal notranslate"><span class="pre">&quot;rejected_mask&quot;</span></code> for each dataset entry</p></li>
<li><p>The masks have the same shape as the response entries, as shown below for the <code class="docutils literal notranslate"><span class="pre">&quot;chosen&quot;</span></code> entry:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;chosen inputs:&quot;</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;chosen mask:  &quot;</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_mask&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>chosen inputs: torch.Size([81])
chosen mask:   torch.Size([81])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The contents of these masks are boolean (<code class="docutils literal notranslate"><span class="pre">True</span></code> and <code class="docutils literal notranslate"><span class="pre">False</span></code>) values:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_mask&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor([False, False, False, False, False, False, False, False, False, False,
        False, False, False, False, False, False, False, False, False, False,
        False, False, False, False, False, False, False, False, False, False,
        False, False, False, False, False, False, False, False, False, False,
        False, False, False, False, False, False, False, False, False, False,
         True,  True,  True,  True,  True,  True,  True,  True,  True,  True,
         True,  True,  True,  True,  True,  True,  True,  True,  True,  True,
         True,  True,  True,  True, False, False, False, False, False, False,
        False], device=&#39;cuda:0&#39;)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">True</span></code> values denote token IDs that correspond to the actual response</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">False</span></code> tokens correspond to token IDs that correspond to either prompt tokens (if we set <code class="docutils literal notranslate"><span class="pre">mask_prompt_tokens=True</span></code> in the <code class="docutils literal notranslate"><span class="pre">customized_collate_fn</span></code> function, which we previously did) or padding tokens</p></li>
<li><p>Hence, we can use the mask as a selection mask to select only the token IDs that correspond to the response, that is, stripping all prompt and padding tokens, as we can see below:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="n">decode_tokens_from_batch</span><span class="p">(</span>
    <span class="n">token_ids</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_mask&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>### Response:
The spelling of the given phrase &quot;freind&quot; is incorrect, the correct spelling is &quot;friend&quot;.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="n">decode_tokens_from_batch</span><span class="p">(</span>
    <span class="n">token_ids</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_mask&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>### Response:
The spelling of the given phrase &quot;freind&quot; is flat out wrong, get it together, the correct spelling is &quot;friend&quot;.
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We will make use of this mask to ignore prompt and padding tokens when computing the DPO loss later</p></li>
</ul>
<p> </p>
</section>
<section id="creating-training-validation-and-test-set-data-loaders">
<h2>2.4) Creating training, validation, and test set data loaders<a class="headerlink" href="#creating-training-validation-and-test-set-data-loaders" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Above, we worked with a small example subsets from the preference dataset for illustration purposes</p></li>
<li><p>Let’s now create the actual training, validation, and test set data loaders</p></li>
<li><p>This process is identical to creating the data loaders in the pretraining and instruction finetuning chapters and thus should be self-explanatory</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>


<span class="n">num_workers</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">PreferenceDataset</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">train_dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">collate_fn</span><span class="o">=</span><span class="n">customized_collate_fn</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">val_dataset</span> <span class="o">=</span> <span class="n">PreferenceDataset</span><span class="p">(</span><span class="n">val_data</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">val_dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">collate_fn</span><span class="o">=</span><span class="n">customized_collate_fn</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span>
<span class="p">)</span>

<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">PreferenceDataset</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">test_dataset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">collate_fn</span><span class="o">=</span><span class="n">customized_collate_fn</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Let’s iterate through the data loader and take a look at the dataset shapes:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train loader:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train loader:
torch.Size([8, 77]) torch.Size([8, 77])
torch.Size([8, 81]) torch.Size([8, 81])
torch.Size([8, 94]) torch.Size([8, 94])
torch.Size([8, 75]) torch.Size([8, 75])
torch.Size([8, 75]) torch.Size([8, 75])
torch.Size([8, 76]) torch.Size([8, 76])
torch.Size([8, 99]) torch.Size([8, 99])
torch.Size([8, 71]) torch.Size([8, 71])
torch.Size([8, 67]) torch.Size([8, 67])
torch.Size([8, 88]) torch.Size([8, 88])
torch.Size([8, 65]) torch.Size([8, 65])
torch.Size([8, 79]) torch.Size([8, 79])
torch.Size([8, 80]) torch.Size([8, 80])
torch.Size([8, 97]) torch.Size([8, 97])
torch.Size([8, 71]) torch.Size([8, 71])
torch.Size([8, 89]) torch.Size([8, 89])
torch.Size([8, 75]) torch.Size([8, 75])
torch.Size([8, 69]) torch.Size([8, 69])
torch.Size([8, 84]) torch.Size([8, 84])
torch.Size([8, 79]) torch.Size([8, 79])
torch.Size([8, 101]) torch.Size([8, 101])
torch.Size([8, 87]) torch.Size([8, 87])
torch.Size([8, 73]) torch.Size([8, 73])
torch.Size([8, 69]) torch.Size([8, 69])
torch.Size([8, 80]) torch.Size([8, 80])
torch.Size([8, 68]) torch.Size([8, 68])
torch.Size([8, 73]) torch.Size([8, 73])
torch.Size([8, 71]) torch.Size([8, 71])
torch.Size([8, 91]) torch.Size([8, 91])
torch.Size([8, 78]) torch.Size([8, 78])
torch.Size([8, 78]) torch.Size([8, 78])
torch.Size([8, 71]) torch.Size([8, 71])
torch.Size([8, 84]) torch.Size([8, 84])
torch.Size([8, 92]) torch.Size([8, 92])
torch.Size([8, 71]) torch.Size([8, 71])
torch.Size([8, 66]) torch.Size([8, 66])
torch.Size([8, 73]) torch.Size([8, 73])
torch.Size([8, 73]) torch.Size([8, 73])
torch.Size([8, 78]) torch.Size([8, 78])
torch.Size([8, 66]) torch.Size([8, 66])
torch.Size([8, 76]) torch.Size([8, 76])
torch.Size([8, 100]) torch.Size([8, 100])
torch.Size([8, 77]) torch.Size([8, 77])
torch.Size([8, 92]) torch.Size([8, 92])
torch.Size([8, 93]) torch.Size([8, 93])
torch.Size([8, 115]) torch.Size([8, 115])
torch.Size([8, 81]) torch.Size([8, 81])
torch.Size([8, 95]) torch.Size([8, 95])
torch.Size([8, 81]) torch.Size([8, 81])
torch.Size([8, 94]) torch.Size([8, 94])
torch.Size([8, 70]) torch.Size([8, 70])
torch.Size([8, 89]) torch.Size([8, 89])
torch.Size([8, 90]) torch.Size([8, 90])
torch.Size([8, 70]) torch.Size([8, 70])
torch.Size([8, 85]) torch.Size([8, 85])
torch.Size([8, 65]) torch.Size([8, 65])
torch.Size([8, 76]) torch.Size([8, 76])
torch.Size([8, 72]) torch.Size([8, 72])
torch.Size([8, 84]) torch.Size([8, 84])
torch.Size([8, 84]) torch.Size([8, 84])
torch.Size([8, 65]) torch.Size([8, 65])
torch.Size([8, 63]) torch.Size([8, 63])
torch.Size([8, 74]) torch.Size([8, 74])
torch.Size([8, 79]) torch.Size([8, 79])
torch.Size([8, 93]) torch.Size([8, 93])
torch.Size([8, 71]) torch.Size([8, 71])
torch.Size([8, 99]) torch.Size([8, 99])
torch.Size([8, 81]) torch.Size([8, 81])
torch.Size([8, 77]) torch.Size([8, 77])
torch.Size([8, 74]) torch.Size([8, 74])
torch.Size([8, 75]) torch.Size([8, 75])
torch.Size([8, 73]) torch.Size([8, 73])
torch.Size([8, 87]) torch.Size([8, 87])
torch.Size([8, 80]) torch.Size([8, 80])
torch.Size([8, 75]) torch.Size([8, 75])
torch.Size([8, 81]) torch.Size([8, 81])
torch.Size([8, 86]) torch.Size([8, 86])
torch.Size([8, 71]) torch.Size([8, 71])
torch.Size([8, 63]) torch.Size([8, 63])
torch.Size([8, 82]) torch.Size([8, 82])
torch.Size([8, 68]) torch.Size([8, 68])
torch.Size([8, 76]) torch.Size([8, 76])
torch.Size([8, 68]) torch.Size([8, 68])
torch.Size([8, 97]) torch.Size([8, 97])
torch.Size([8, 72]) torch.Size([8, 72])
torch.Size([8, 85]) torch.Size([8, 85])
torch.Size([8, 67]) torch.Size([8, 67])
torch.Size([8, 85]) torch.Size([8, 85])
torch.Size([8, 87]) torch.Size([8, 87])
torch.Size([8, 76]) torch.Size([8, 76])
torch.Size([8, 74]) torch.Size([8, 74])
torch.Size([8, 92]) torch.Size([8, 92])
torch.Size([8, 85]) torch.Size([8, 85])
torch.Size([8, 72]) torch.Size([8, 72])
torch.Size([8, 93]) torch.Size([8, 93])
torch.Size([8, 82]) torch.Size([8, 82])
torch.Size([8, 76]) torch.Size([8, 76])
torch.Size([8, 93]) torch.Size([8, 93])
torch.Size([8, 80]) torch.Size([8, 80])
torch.Size([8, 87]) torch.Size([8, 87])
torch.Size([8, 69]) torch.Size([8, 69])
torch.Size([8, 90]) torch.Size([8, 90])
torch.Size([8, 99]) torch.Size([8, 99])
torch.Size([8, 104]) torch.Size([8, 104])
torch.Size([8, 101]) torch.Size([8, 101])
torch.Size([8, 98]) torch.Size([8, 98])
torch.Size([8, 79]) torch.Size([8, 79])
torch.Size([8, 71]) torch.Size([8, 71])
torch.Size([8, 76]) torch.Size([8, 76])
torch.Size([8, 79]) torch.Size([8, 79])
torch.Size([8, 79]) torch.Size([8, 79])
torch.Size([8, 67]) torch.Size([8, 67])
torch.Size([8, 84]) torch.Size([8, 84])
torch.Size([8, 78]) torch.Size([8, 78])
torch.Size([8, 85]) torch.Size([8, 85])
torch.Size([8, 70]) torch.Size([8, 70])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Each row shows the shape of the <code class="docutils literal notranslate"><span class="pre">&quot;chosen&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;rejected&quot;</span></code> entries in each batch</p></li>
<li><p>Since we applied padding on a batch-by-batch basis, each row has a different shape</p></li>
<li><p>This is for efficiency reasons because it would be inefficient to pad all samples to the longest sample in the whole dataset</p></li>
</ul>
<p> </p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="loading-a-finetuned-llm-for-dpo-alignment">
<h1>3) Loading a finetuned LLM for DPO alignment<a class="headerlink" href="#loading-a-finetuned-llm-for-dpo-alignment" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>LLM alignment steps, such as RLHF or DPO, assume that we already have an instruction-finetuned model</p></li>
<li><p>This section contains minimal code to load the model that was instruction finetuned and saved in chapter 7 (via <a class="reference internal" href="../01_main-chapter-code/ch07.html"><span class="std std-doc">../01_main-chapter-code/ch07.ipynb</span></a>)</p></li>
<li><p>Make sure you run the chapter 7 code first to create the instruction-finetuned model before you proceed</p></li>
<li><p>The code below will copy the instruction-finetuned model into the current directory:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>


<span class="n">finetuned_model_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;gpt2-medium355M-sft.pth&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">finetuned_model_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>

    <span class="c1"># Try finding the model checkpoint locally:</span>
    <span class="n">relative_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;01_main-chapter-code&quot;</span> <span class="o">/</span> <span class="n">finetuned_model_path</span>
    <span class="k">if</span> <span class="n">relative_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">relative_path</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

    <span class="c1"># If this notebook is run on Google Colab, get it from a Google Drive folder</span>
    <span class="k">elif</span> <span class="s2">&quot;COLAB_GPU&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">or</span> <span class="s2">&quot;COLAB_TPU_ADDR&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">drive</span>
        <span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s2">&quot;/content/drive&quot;</span><span class="p">)</span>
        <span class="n">google_drive_path</span> <span class="o">=</span> <span class="s2">&quot;/content/drive/My Drive/Books/LLMs-From-Scratch/ch07/colab/gpt2-medium355M-sft.pth&quot;</span>  <span class="c1"># Readers need to adjust this path</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">google_drive_path</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not find &#39;</span><span class="si">{</span><span class="n">finetuned_model_path</span><span class="si">}</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Run the `ch07.ipynb` notebook to finetune and save the finetuned model.&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Next, we reuse the basic configuration from previous chapters to load the model weights:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">previous_chapters</span><span class="w"> </span><span class="kn">import</span> <span class="n">GPTModel</span>
<span class="c1"># If the `previous_chapters.py` file is not available locally,</span>
<span class="c1"># you can import it from the `llms-from-scratch` PyPI package.</span>
<span class="c1"># For details, see: https://github.com/rasbt/LLMs-from-scratch/tree/main/pkg</span>
<span class="c1"># E.g.,</span>
<span class="c1"># from llms_from_scratch.ch04 import GPTModel</span>


<span class="n">BASE_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;vocab_size&quot;</span><span class="p">:</span> <span class="mi">50257</span><span class="p">,</span>     <span class="c1"># Vocabulary size</span>
    <span class="s2">&quot;context_length&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>  <span class="c1"># Context length</span>
    <span class="s2">&quot;drop_rate&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>        <span class="c1"># Dropout rate</span>
    <span class="s2">&quot;qkv_bias&quot;</span><span class="p">:</span> <span class="kc">True</span>         <span class="c1"># Query-key-value bias</span>
<span class="p">}</span>

<span class="n">model_configs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gpt2-small (124M)&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;emb_dim&quot;</span><span class="p">:</span> <span class="mi">768</span><span class="p">,</span> <span class="s2">&quot;n_layers&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;n_heads&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
    <span class="s2">&quot;gpt2-medium (355M)&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;emb_dim&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="s2">&quot;n_layers&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span> <span class="s2">&quot;n_heads&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">},</span>
    <span class="s2">&quot;gpt2-large (774M)&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;emb_dim&quot;</span><span class="p">:</span> <span class="mi">1280</span><span class="p">,</span> <span class="s2">&quot;n_layers&quot;</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span> <span class="s2">&quot;n_heads&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
    <span class="s2">&quot;gpt2-xl (1558M)&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;emb_dim&quot;</span><span class="p">:</span> <span class="mi">1600</span><span class="p">,</span> <span class="s2">&quot;n_layers&quot;</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span> <span class="s2">&quot;n_heads&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">},</span>
<span class="p">}</span>

<span class="n">CHOOSE_MODEL</span> <span class="o">=</span> <span class="s2">&quot;gpt2-medium (355M)&quot;</span>

<span class="n">BASE_CONFIG</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_configs</span><span class="p">[</span><span class="n">CHOOSE_MODEL</span><span class="p">])</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">GPTModel</span><span class="p">(</span><span class="n">BASE_CONFIG</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
        <span class="s2">&quot;gpt2-medium355M-sft.pth&quot;</span><span class="p">,</span>
        <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span>
        <span class="n">weights_only</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Before training the loaded model with DPO, let’s make sure that the finetuned model was saved and loaded correctly by trying it out on some sample data:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Below is an instruction that describes a task. Write a response</span>
<span class="s2">that appropriately completes the request.</span>

<span class="s2">### Instruction:</span>
<span class="s2">Convert the active sentence to passive: &#39;The chef cooks the meal every day.&#39;</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">previous_chapters</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">generate</span><span class="p">,</span>
    <span class="n">text_to_token_ids</span><span class="p">,</span>
    <span class="n">token_ids_to_text</span>
<span class="p">)</span>
<span class="c1"># Alternatively:</span>
<span class="c1"># from llms_from_scratch.ch05 (</span>
<span class="c1">#     generate,</span>
<span class="c1">#     text_to_token_ids,</span>
<span class="c1">#     token_ids_to_text</span>
<span class="c1"># )</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>

<span class="n">token_ids</span> <span class="o">=</span> <span class="n">generate</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">idx</span><span class="o">=</span><span class="n">text_to_token_ids</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">),</span>
    <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span>
    <span class="n">context_size</span><span class="o">=</span><span class="n">BASE_CONFIG</span><span class="p">[</span><span class="s2">&quot;context_length&quot;</span><span class="p">],</span>
    <span class="n">eos_id</span><span class="o">=</span><span class="mi">50256</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">token_ids_to_text</span><span class="p">(</span><span class="n">token_ids</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Below is an instruction that describes a task. Write a response
that appropriately completes the request.

### Instruction:
Convert the active sentence to passive: &#39;The chef cooks the meal every day.&#39;

### Response:
The meal is cooked every day by the chef.
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>As we can see above, the model gives a reasonable and correct response</p></li>
<li><p>As explained in chapter 7, in practice, we would clean up the response to only return the response text with the prompt and prompt style removed (similar to what you are familiar with from ChatGPT, for example):</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">extract_response</span><span class="p">(</span><span class="n">response_text</span><span class="p">,</span> <span class="n">input_text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">response_text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">input_text</span><span class="p">):]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;### Response:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">extract_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The meal is cooked every day by the chef.
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Now, we are almost ready to get to the DPO part</p></li>
<li><p>As mentioned at the beginning of this notebook, DPO works with two LLMs: a policy model (the LLM that we want to optimize) and a reference model (the original model that we keep unchanged)</p></li>
<li><p>Below, we rename the <code class="docutils literal notranslate"><span class="pre">model</span></code> as <code class="docutils literal notranslate"><span class="pre">policy_model</span></code> and instantiate a second instance of the model we refer to as the <code class="docutils literal notranslate"><span class="pre">reference_model</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">policy_model</span> <span class="o">=</span> <span class="n">model</span>

<span class="n">reference_model</span> <span class="o">=</span> <span class="n">GPTModel</span><span class="p">(</span><span class="n">BASE_CONFIG</span><span class="p">)</span>
<span class="n">reference_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
        <span class="s2">&quot;gpt2-medium355M-sft.pth&quot;</span><span class="p">,</span>
        <span class="n">map_location</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span>
        <span class="n">weights_only</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">reference_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="n">policy_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">reference_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p> </p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="coding-the-dpo-loss-function">
<h1>4) Coding the DPO Loss Function<a class="headerlink" href="#coding-the-dpo-loss-function" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>After we took care of the model loading and dataset preparation in the previous sections, we can now get to the fun part and code the DPO loss</p></li>
<li><p>Note that the DPO loss code below is based on the method proposed in the <a class="reference external" href="https://arxiv.org/abs/2305.18290">Direct Preference Optimization: Your Language Model is Secretly a Reward Model</a> paper</p></li>
<li><p>For reference, the core DPO equation is shown again below:</p></li>
</ul>
<img src="https://sebastianraschka.com/images/LLMs-from-scratch-images/dpo/3.webp?123" width=800px>
<ul class="simple">
<li><p>In the equation above,</p>
<ul>
<li><p>“expected value” <span class="math notranslate nohighlight">\(\mathbb{E}\)</span> is statistics jargon and stands for the average or mean value of the random variable (the expression inside the brackets); optimizing <span class="math notranslate nohighlight">\(-\mathbb{E}\)</span> aligns the model better with user preferences</p></li>
<li><p>The <span class="math notranslate nohighlight">\(\pi_{\theta}\)</span> variable is the so-called policy (a term borrowed from reinforcement learning) and represents the LLM we want to optimize; <span class="math notranslate nohighlight">\(\pi_{ref}\)</span> is a reference LLM, which is typically the original LLM before optimization (at the beginning of the training, <span class="math notranslate nohighlight">\(\pi_{\theta}\)</span> and <span class="math notranslate nohighlight">\(\pi_{ref}\)</span> are typically the same)</p></li>
<li><p><span class="math notranslate nohighlight">\(\beta\)</span> is a hyperparameter to control the divergence between the <span class="math notranslate nohighlight">\(\pi_{\theta}\)</span> and the reference model; increasing <span class="math notranslate nohighlight">\(\beta\)</span> increases the impact of the difference between
<span class="math notranslate nohighlight">\(\pi_{\theta}\)</span> and <span class="math notranslate nohighlight">\(\pi_{ref}\)</span> in terms of their log probabilities on the overall loss function, thereby increasing the divergence between the two models</p></li>
<li><p>the logistic sigmoid function, <span class="math notranslate nohighlight">\(\sigma(\centerdot)\)</span> transforms the log-odds of the preferred and rejected responses (the terms inside the logistic sigmoid function) into a probability score</p></li>
</ul>
</li>
<li><p>In code, we can implement the DPO loss as follows:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_dpo_loss</span><span class="p">(</span>
      <span class="n">model_chosen_logprobs</span><span class="p">,</span>
      <span class="n">model_rejected_logprobs</span><span class="p">,</span>
      <span class="n">reference_chosen_logprobs</span><span class="p">,</span>
      <span class="n">reference_rejected_logprobs</span><span class="p">,</span>
      <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the DPO loss for a batch of policy and reference model log probabilities.</span>

<span class="sd">    Args:</span>
<span class="sd">        policy_chosen_logprobs: Log probabilities of the policy model for the chosen responses. Shape: (batch_size,)</span>
<span class="sd">        policy_rejected_logprobs: Log probabilities of the policy model for the rejected responses. Shape: (batch_size,)</span>
<span class="sd">        reference_chosen_logprobs: Log probabilities of the reference model for the chosen responses. Shape: (batch_size,)</span>
<span class="sd">        reference_rejected_logprobs: Log probabilities of the reference model for the rejected responses. Shape: (batch_size,)</span>
<span class="sd">        beta: Temperature parameter for the DPO loss; typically something in the range of 0.1 to 0.5. We ignore the reference model as beta -&gt; 0.</span>
<span class="sd">        label_smoothing: conservativeness for DPO loss.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple of three tensors: (loss, chosen_rewards, rejected_rewards).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_logratios</span> <span class="o">=</span> <span class="n">model_chosen_logprobs</span> <span class="o">-</span> <span class="n">model_rejected_logprobs</span>
    <span class="n">reference_logratios</span> <span class="o">=</span> <span class="n">reference_chosen_logprobs</span> <span class="o">-</span> <span class="n">reference_rejected_logprobs</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">model_logratios</span> <span class="o">-</span> <span class="n">reference_logratios</span>

    <span class="c1"># DPO (Eq. 7 of https://arxiv.org/pdf/2305.18290.pdf)</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="o">-</span><span class="n">F</span><span class="o">.</span><span class="n">logsigmoid</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">logits</span><span class="p">)</span>

    <span class="c1"># Optional values to track progress during training</span>
    <span class="n">chosen_rewards</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_chosen_logprobs</span> <span class="o">-</span> <span class="n">reference_chosen_logprobs</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">rejected_rewards</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_rejected_logprobs</span> <span class="o">-</span> <span class="n">reference_rejected_logprobs</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

    <span class="c1"># .mean() to average over the samples in the batch</span>
    <span class="k">return</span> <span class="n">losses</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">chosen_rewards</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">rejected_rewards</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<ul>
<li><p>If you are familiar with logarithms, note that we have the general relationship <span class="math notranslate nohighlight">\(\log\left(\frac{a}{b}\right) = \log a - \log b\)</span>, which we applied in the code above</p></li>
<li><p>Keeping this in mind, let’s go through some of the steps (we will calculate the <code class="docutils literal notranslate"><span class="pre">logprobs</span></code> using a separate function later)</p></li>
<li><p>Let’s start with the lines</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_logratios</span> <span class="o">=</span> <span class="n">model_chosen_logprobs</span> <span class="o">-</span> <span class="n">model_rejected_logprobs</span>
<span class="n">reference_logratios</span> <span class="o">=</span> <span class="n">reference_chosen_logprobs</span> <span class="o">-</span> <span class="n">reference_rejected_logprobs</span>
</pre></div>
</div>
</li>
<li><p>These lines above calculate the difference in log probabilities (logits) for the chosen and rejected samples for both the policy model and the reference model (this is due to <span class="math notranslate nohighlight">\(\log\left(\frac{a}{b}\right) = \log a - \log b\)</span>):</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\log \left( \frac{\pi_\theta (y_w \mid x)}{\pi_\theta (y_l \mid x)} \right) \quad \text{and} \quad \log \left( \frac{\pi_{\text{ref}}(y_w \mid x)}{\pi_{\text{ref}}(y_l \mid x)} \right)\]</div>
<ul class="simple">
<li><p>Next, the code <code class="docutils literal notranslate"><span class="pre">logits</span> <span class="pre">=</span> <span class="pre">model_logratios</span> <span class="pre">-</span> <span class="pre">reference_logratios</span></code> computes the difference between the model’s log ratios and the reference model’s log ratios, i.e.,</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\beta \log \left( \frac{\pi_\theta (y_w \mid x)}{\pi_{\text{ref}} (y_w \mid x)} \right)
- \beta \log \left( \frac{\pi_\theta (y_l \mid x)}{\pi_{\text{ref}} (y_l \mid x)} \right)\]</div>
<ul class="simple">
<li><p>Finally, <code class="docutils literal notranslate"><span class="pre">losses</span> <span class="pre">=</span> <span class="pre">-F.logsigmoid(beta</span> <span class="pre">*</span> <span class="pre">logits)</span></code>  calculates the loss using the log-sigmoid function; in the original equation, the term inside the expectation is</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\log \sigma \left( \beta \log \left( \frac{\pi_\theta (y_w \mid x)}{\pi_{\text{ref}} (y_w \mid x)} \right)
- \beta \log \left( \frac{\pi_\theta (y_l \mid x)}{\pi_{\text{ref}} (y_l \mid x)} \right) \right)\]</div>
<ul class="simple">
<li><p>Above, we assumed that the log probabilities were already computed; let’s now define a <code class="docutils literal notranslate"><span class="pre">compute_logprobs</span></code> function that we can use to compute these log probabilities that were passed into the <code class="docutils literal notranslate"><span class="pre">compute_dpo_loss</span></code> function above, that is, the values <span class="math notranslate nohighlight">\(\pi_\theta (y_w \mid x)\)</span>, <span class="math notranslate nohighlight">\({\pi_\theta (y_l \mid x)}\)</span>, and so forth:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_logprobs</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">selection_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute log probabilities.</span>

<span class="sd">    Args:</span>
<span class="sd">      logits: Tensor of shape (batch_size, num_tokens, vocab_size)</span>
<span class="sd">      labels: Tensor of shape (batch_size, num_tokens)</span>
<span class="sd">      selection_mask: Tensor for shape (batch_size, num_tokens)</span>

<span class="sd">    Returns:</span>
<span class="sd">      mean_log_prob: Mean log probability excluding padding tokens.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Labels are the inputs shifted by one</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

    <span class="c1"># Truncate logits to match the labels num_tokens</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">log_probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Gather the log probabilities for the actual labels</span>
    <span class="n">selected_log_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">log_probs</span><span class="p">,</span>
        <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="n">labels</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">selection_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">selection_mask</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>

        <span class="c1"># Apply the mask to filter out padding tokens</span>
        <span class="n">selected_log_probs</span> <span class="o">=</span> <span class="n">selected_log_probs</span> <span class="o">*</span> <span class="n">mask</span>

        <span class="c1"># Calculate the average log probability excluding padding tokens</span>
        <span class="c1"># This averages over the tokens, so the shape is (batch_size, num_tokens)</span>
        <span class="n">avg_log_prob</span> <span class="o">=</span> <span class="n">selected_log_probs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">avg_log_prob</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">selected_log_probs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Note that this function above might look a bit intimidating at first due to the <code class="docutils literal notranslate"><span class="pre">torch.gather</span></code> function, but it’s pretty similar to what happens under the hood in PyTorch’s <code class="docutils literal notranslate"><span class="pre">cross_entropy</span></code> function</p></li>
<li><p>For example, consider the following example:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sample data</span>
<span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
    <span class="p">[[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
     <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]])</span>  <span class="c1"># Shape: (2, 3)</span>
<span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>  <span class="c1"># Shape: (2,)</span>


<span class="c1"># Manual loss using torch.gather</span>
<span class="n">log_softmax_logits</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Shape: (2, 3)</span>
<span class="n">selected_log_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
    <span class="nb">input</span><span class="o">=</span><span class="n">log_softmax_logits</span><span class="p">,</span>
    <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">index</span><span class="o">=</span><span class="n">targets</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="c1"># Shape 2, 1</span>
<span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Shape: (2,)</span>
<span class="n">manual_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">selected_log_probs</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># Averaging over the batch</span>


<span class="c1"># PyTorch loss</span>
<span class="n">cross_entropy_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">manual_loss</span><span class="p">,</span> <span class="n">cross_entropy_loss</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor(1.4185) tensor(1.4185)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>So, above, we can see that the two implementations are equivalent, but let’s narrow down a bit further to the <code class="docutils literal notranslate"><span class="pre">torch.gather</span></code> mechanics</p></li>
<li><p>Consider the following two tensors:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
  <span class="p">[[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,],</span>
   <span class="p">[</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">]]</span>
<span class="p">)</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
  <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Above, <code class="docutils literal notranslate"><span class="pre">t</span></code> is a tensor we want to select from, and <code class="docutils literal notranslate"><span class="pre">m</span></code> is a mask to specify how we want to select</p></li>
<li><p>For instance, since <code class="docutils literal notranslate"><span class="pre">m</span></code> contains <code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">1]</span></code> n the first row, it will select two times the value of <code class="docutils literal notranslate"><span class="pre">t</span></code> in index position <code class="docutils literal notranslate"><span class="pre">1</span></code>, which is the value 2.</p></li>
<li><p>The second row of <code class="docutils literal notranslate"><span class="pre">m</span></code>, <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">1]</span></code>, selects index positions 0 and 1 in the second row or <code class="docutils literal notranslate"><span class="pre">t</span></code>, which are <code class="docutils literal notranslate"><span class="pre">3.</span></code> and <code class="docutils literal notranslate"><span class="pre">4.</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensor([[2., 2.],
        [3., 4.]])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>In other words, <code class="docutils literal notranslate"><span class="pre">torch.gather</span></code> is a selection function</p></li>
<li><p>When we computed the loss earlier, we used it to retrieve the log probabilities corresponding to the correct token in the 50,256-token vocabulary</p></li>
<li><p>The “correct” tokens are the tokens given in the response entry</p></li>
</ul>
<ul class="simple">
<li><p>Regarding the <code class="docutils literal notranslate"><span class="pre">compute_logprobs</span></code> function above, we use <code class="docutils literal notranslate"><span class="pre">torch.gather</span></code> here because it gives us a bit more control than <code class="docutils literal notranslate"><span class="pre">cross_entropy</span></code>, but is, in essence, a similar idea</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">selection_mask</span></code> we use there is to optionally ignore prompt and padding tokens</p></li>
<li><p>We can then use the <code class="docutils literal notranslate"><span class="pre">compute_logprobs</span></code> function as follows to compute the inputs for the <code class="docutils literal notranslate"><span class="pre">compute_dpo_loss</span></code> loss function</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_dpo_loss_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">policy_model</span><span class="p">,</span> <span class="n">reference_model</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the DPO loss on an input batch&quot;&quot;&quot;</span>

    <span class="c1"># where policy_model(batch[&quot;chosen&quot;]) are the logits</span>
    <span class="n">policy_chosen_log_probas</span> <span class="o">=</span> <span class="n">compute_logprobs</span><span class="p">(</span>
        <span class="n">logits</span><span class="o">=</span><span class="n">policy_model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">]),</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">],</span>
        <span class="n">selection_mask</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_mask&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">policy_rejected_log_probas</span> <span class="o">=</span> <span class="n">compute_logprobs</span><span class="p">(</span>
        <span class="n">logits</span><span class="o">=</span><span class="n">policy_model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">]),</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">],</span>
        <span class="n">selection_mask</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_mask&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">ref_chosen_log_probas</span> <span class="o">=</span> <span class="n">compute_logprobs</span><span class="p">(</span>
            <span class="n">logits</span><span class="o">=</span><span class="n">reference_model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">]),</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">],</span>
            <span class="n">selection_mask</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_mask&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ref_rejected_log_probas</span> <span class="o">=</span> <span class="n">compute_logprobs</span><span class="p">(</span>
            <span class="n">logits</span><span class="o">=</span><span class="n">reference_model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">]),</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">],</span>
            <span class="n">selection_mask</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_mask&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="n">loss</span><span class="p">,</span> <span class="n">chosen_rewards</span><span class="p">,</span> <span class="n">rejected_rewards</span> <span class="o">=</span> <span class="n">compute_dpo_loss</span><span class="p">(</span>
        <span class="n">model_chosen_logprobs</span><span class="o">=</span><span class="n">policy_chosen_log_probas</span><span class="p">,</span>
        <span class="n">model_rejected_logprobs</span><span class="o">=</span><span class="n">policy_rejected_log_probas</span><span class="p">,</span>
        <span class="n">reference_chosen_logprobs</span><span class="o">=</span><span class="n">ref_chosen_log_probas</span><span class="p">,</span>
        <span class="n">reference_rejected_logprobs</span><span class="o">=</span><span class="n">ref_rejected_log_probas</span><span class="p">,</span>
        <span class="n">beta</span><span class="o">=</span><span class="n">beta</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">chosen_rewards</span><span class="p">,</span> <span class="n">rejected_rewards</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The above function works for a single batch, for example:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">compute_dpo_loss_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">policy_model</span><span class="p">,</span> <span class="n">reference_model</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(tensor(0.6931, device=&#39;cuda:0&#39;), tensor(0., device=&#39;cuda:0&#39;), tensor(0., device=&#39;cuda:0&#39;))
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Below, we extend this function to work for a specified <code class="docutils literal notranslate"><span class="pre">num_batches</span></code> in a data loader:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compute_dpo_loss_loader</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">policy_model</span><span class="p">,</span> <span class="n">reference_model</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">num_batches</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply compute_dpo_loss_batch to a whole data loader&quot;&quot;&quot;</span>

    <span class="n">total_loss</span><span class="p">,</span> <span class="n">total_chosen_rewards</span><span class="p">,</span> <span class="n">total_rejected_rewards</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">num_batches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Reduce the number of batches to match the total number of batches in the data loader</span>
        <span class="c1"># if num_batches exceeds the number of batches in the data loader</span>
        <span class="n">num_batches</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_batches</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_loader</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_batches</span><span class="p">:</span>
            <span class="n">loss</span><span class="p">,</span> <span class="n">chosen_rewards</span><span class="p">,</span> <span class="n">rejected_rewards</span> <span class="o">=</span> <span class="n">compute_dpo_loss_batch</span><span class="p">(</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                <span class="n">policy_model</span><span class="o">=</span><span class="n">policy_model</span><span class="p">,</span>
                <span class="n">reference_model</span><span class="o">=</span><span class="n">reference_model</span><span class="p">,</span>
                <span class="n">beta</span><span class="o">=</span><span class="n">beta</span>
            <span class="p">)</span>
            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">total_chosen_rewards</span> <span class="o">+=</span> <span class="n">chosen_rewards</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">total_rejected_rewards</span> <span class="o">+=</span> <span class="n">rejected_rewards</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># calculate average</span>
    <span class="n">total_loss</span> <span class="o">/=</span> <span class="n">num_batches</span>
    <span class="n">total_chosen_rewards</span> <span class="o">/=</span> <span class="n">num_batches</span>
    <span class="n">total_rejected_rewards</span> <span class="o">/=</span> <span class="n">num_batches</span>
    <span class="k">return</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">total_chosen_rewards</span><span class="p">,</span> <span class="n">total_rejected_rewards</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Why a specified <code class="docutils literal notranslate"><span class="pre">num_batches</span></code>? That’s purely for efficiency reasons (because calculating the loss on the whole dataset each time would slow down the training significantly)</p></li>
</ul>
<ul class="simple">
<li><p>Lastly, we define a convenience function for our training function later; this <code class="docutils literal notranslate"><span class="pre">evaluate_dpo_loss_loader</span></code> function computes the DPO loss and rewards for both the training and validation loader for logging purposes:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_dpo_loss_loader</span><span class="p">(</span><span class="n">policy_model</span><span class="p">,</span> <span class="n">reference_model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">eval_iter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the DPO loss for the training and validation dataset&quot;&quot;&quot;</span>

    <span class="n">policy_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">train_loss</span><span class="p">,</span> <span class="n">train_chosen_rewards</span><span class="p">,</span> <span class="n">train_rejected_rewards</span> <span class="o">=</span> <span class="n">compute_dpo_loss_loader</span><span class="p">(</span>
            <span class="n">data_loader</span><span class="o">=</span><span class="n">train_loader</span><span class="p">,</span>
            <span class="n">policy_model</span><span class="o">=</span><span class="n">policy_model</span><span class="p">,</span>
            <span class="n">reference_model</span><span class="o">=</span><span class="n">reference_model</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">num_batches</span><span class="o">=</span><span class="n">eval_iter</span>
        <span class="p">)</span>

        <span class="n">val_loss</span><span class="p">,</span> <span class="n">val_chosen_rewards</span><span class="p">,</span> <span class="n">val_rejected_rewards</span> <span class="o">=</span> <span class="n">compute_dpo_loss_loader</span><span class="p">(</span>
            <span class="n">data_loader</span><span class="o">=</span><span class="n">val_loader</span><span class="p">,</span>
            <span class="n">policy_model</span><span class="o">=</span><span class="n">policy_model</span><span class="p">,</span>
            <span class="n">reference_model</span><span class="o">=</span><span class="n">reference_model</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
            <span class="n">num_batches</span><span class="o">=</span><span class="n">eval_iter</span>
        <span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;train_loss&quot;</span><span class="p">:</span> <span class="n">train_loss</span><span class="p">,</span>
        <span class="s2">&quot;train_chosen_reward&quot;</span><span class="p">:</span> <span class="n">train_chosen_rewards</span><span class="p">,</span>
        <span class="s2">&quot;train_rejected_reward&quot;</span><span class="p">:</span> <span class="n">train_rejected_rewards</span><span class="p">,</span>
        <span class="s2">&quot;val_loss&quot;</span><span class="p">:</span> <span class="n">val_loss</span><span class="p">,</span>
        <span class="s2">&quot;val_chosen_reward&quot;</span><span class="p">:</span> <span class="n">val_chosen_rewards</span><span class="p">,</span>
        <span class="s2">&quot;val_rejected_reward&quot;</span><span class="p">:</span> <span class="n">val_rejected_rewards</span>
    <span class="p">}</span>

    <span class="n">policy_model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>In this section, we covered a lot of ground as a brief recap:</p>
<ul>
<li><p>The flow is: compute <code class="docutils literal notranslate"><span class="pre">logits</span></code> via the models <span class="math notranslate nohighlight">\(\rightarrow\)</span> <code class="docutils literal notranslate"><span class="pre">compute_logprobs</span></code> from logits <span class="math notranslate nohighlight">\(\rightarrow\)</span> compute <code class="docutils literal notranslate"><span class="pre">compute_dpo_loss</span></code> from log probabilities</p></li>
<li><p>we have the <code class="docutils literal notranslate"><span class="pre">compute_dpo_loss_batch</span></code> function that facilitates the process above</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">compute_dpo_loss_loader</span></code> utility function applies the <code class="docutils literal notranslate"><span class="pre">compute_dpo_loss_batch</span></code> function to a data loader</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">evaluate_dpo_loss_loader</span></code> function applies the <code class="docutils literal notranslate"><span class="pre">compute_dpo_loss_batch</span></code> to both the training and validation set data loaders for logging purposes</p></li>
</ul>
</li>
</ul>
<p> </p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="training-the-model">
<h1>5) Training the model<a class="headerlink" href="#training-the-model" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>After setting up the DPO loss functions in the previous section, we can now finally train the model</p></li>
<li><p>Note that this training function is the same one we used for pretraining and instruction finetuning, with minor differences:</p></li>
<li><p>we swap the cross-entropy loss with our new DPO loss function</p></li>
<li><p>we also track the rewards and reward margins, which are commonly used in RLHF and DPO contexts to track the training progress</p></li>
</ul>
<ul class="simple">
<li><p>Before we start the training, let’s print the initial losses and rewards:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">previous_chapters</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_and_print_sample</span>
<span class="c1"># Alternatively:</span>
<span class="c1"># from llms_from_scratch.ch04 import generate_text_simple</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train_model_dpo_simple</span><span class="p">(</span>
    <span class="n">policy_model</span><span class="p">,</span> <span class="n">reference_model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span>
    <span class="n">eval_freq</span><span class="p">,</span> <span class="n">eval_iter</span><span class="p">,</span> <span class="n">start_context</span><span class="p">,</span> <span class="n">tokenizer</span>
<span class="p">):</span>

    <span class="c1"># Initialize lists to track losses and tokens seen</span>
    <span class="n">tracking</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;train_losses&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;train_chosen_rewards&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;train_rejected_rewards&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;val_losses&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;val_chosen_rewards&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;val_rejected_rewards&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;tokens_seen&quot;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>
    <span class="n">tokens_seen</span><span class="p">,</span> <span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># Main training loop</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="n">policy_model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>  <span class="c1"># Set model to training mode</span>

        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>

            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>  <span class="c1"># Reset loss gradients from previous batch iteration</span>

            <span class="n">loss</span><span class="p">,</span> <span class="n">chosen_rewards</span><span class="p">,</span> <span class="n">rejected_rewards</span> <span class="o">=</span> <span class="n">compute_dpo_loss_batch</span><span class="p">(</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
                <span class="n">policy_model</span><span class="o">=</span><span class="n">policy_model</span><span class="p">,</span>
                <span class="n">reference_model</span><span class="o">=</span><span class="n">reference_model</span><span class="p">,</span>
                <span class="n">beta</span><span class="o">=</span><span class="n">beta</span>
            <span class="p">)</span>

            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>  <span class="c1"># Calculate loss gradients</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>  <span class="c1"># Update model weights using loss gradients</span>

            <span class="n">tokens_seen</span> <span class="o">+=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
            <span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Optional evaluation step</span>
            <span class="k">if</span> <span class="n">global_step</span> <span class="o">%</span> <span class="n">eval_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">evaluate_dpo_loss_loader</span><span class="p">(</span>
                    <span class="n">policy_model</span><span class="o">=</span><span class="n">policy_model</span><span class="p">,</span>
                    <span class="n">reference_model</span><span class="o">=</span><span class="n">reference_model</span><span class="p">,</span>
                    <span class="n">train_loader</span><span class="o">=</span><span class="n">train_loader</span><span class="p">,</span>
                    <span class="n">val_loader</span><span class="o">=</span><span class="n">val_loader</span><span class="p">,</span>
                    <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
                    <span class="n">eval_iter</span><span class="o">=</span><span class="n">eval_iter</span>
                <span class="p">)</span>
                <span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;train_losses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;train_loss&quot;</span><span class="p">])</span>
                <span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;train_chosen_rewards&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;train_chosen_reward&quot;</span><span class="p">])</span>
                <span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;train_rejected_rewards&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;train_rejected_reward&quot;</span><span class="p">])</span>
                <span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;val_losses&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">])</span>
                <span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;val_chosen_rewards&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;val_chosen_reward&quot;</span><span class="p">])</span>
                <span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;val_rejected_rewards&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;val_rejected_reward&quot;</span><span class="p">])</span>
                <span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;tokens_seen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokens_seen</span><span class="p">)</span>
                <span class="n">train_reward_margin</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;train_chosen_reward&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;train_rejected_reward&quot;</span><span class="p">]</span>
                <span class="n">val_reward_margin</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;val_chosen_reward&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;val_rejected_reward&quot;</span><span class="p">]</span>

                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Ep </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (Step </span><span class="si">{</span><span class="n">global_step</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">): &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Train loss </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, Val loss </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Train reward margins </span><span class="si">{</span><span class="n">train_reward_margin</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Val reward margins </span><span class="si">{</span><span class="n">val_reward_margin</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Print a sample text after each epoch</span>
        <span class="n">generate_and_print_sample</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">loss</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">start_context</span><span class="o">=</span><span class="n">start_context</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">tracking</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span> <span class="c1"># For reproducibility due to the shuffling in the data loader</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">evaluate_dpo_loss_loader</span><span class="p">(</span>
    <span class="n">policy_model</span><span class="o">=</span><span class="n">policy_model</span><span class="p">,</span>
    <span class="n">reference_model</span><span class="o">=</span><span class="n">reference_model</span><span class="p">,</span>
    <span class="n">train_loader</span><span class="o">=</span><span class="n">train_loader</span><span class="p">,</span>
    <span class="n">val_loader</span><span class="o">=</span><span class="n">val_loader</span><span class="p">,</span>
    <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">eval_iter</span><span class="o">=</span><span class="mi">5</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training loss:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;train_loss&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Validation loss:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train reward margin:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;train_chosen_reward&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;train_rejected_reward&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Val reward margin:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;val_chosen_reward&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;val_rejected_reward&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training loss: 0.6931471824645996
Validation loss: 0.6931471824645996
Train reward margin: 0.0
Val reward margin: 0.0
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Also, let’s take a look at some of the initial model responses (the first 3 examples in the validation set):</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>


<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">val_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>

    <span class="n">input_text</span> <span class="o">=</span> <span class="n">format_input</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="n">token_ids</span> <span class="o">=</span> <span class="n">generate</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">idx</span><span class="o">=</span><span class="n">text_to_token_ids</span><span class="p">(</span><span class="n">input_text</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">context_size</span><span class="o">=</span><span class="n">BASE_CONFIG</span><span class="p">[</span><span class="s2">&quot;context_length&quot;</span><span class="p">],</span>
        <span class="n">eos_id</span><span class="o">=</span><span class="mi">50256</span>
    <span class="p">)</span>
    <span class="n">generated_text</span> <span class="o">=</span> <span class="n">token_ids_to_text</span><span class="p">(</span><span class="n">token_ids</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
    <span class="n">response_text</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">generated_text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">input_text</span><span class="p">):]</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;### Response:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Correct response:</span><span class="se">\n</span><span class="s2">&gt;&gt; </span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Model response:</span><span class="se">\n</span><span class="s2">&gt;&gt; </span><span class="si">{</span><span class="n">response_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Convert the active sentence to passive: &#39;The chef cooks the meal every day.&#39;

Correct response:
&gt;&gt; The meal is cooked by the chef every day.

Model response:
&gt;&gt; The meal is cooked every day by the chef.

-------------------------------------

Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Classify an input string as either a noun or a verb.

### Input:
Dance

Correct response:
&gt;&gt; &#39;Dance&#39; can be classified as a verb.

Model response:
&gt;&gt; &quot;Dance&quot; can be classified as a verb.

-------------------------------------

Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Rewrite the sentence using a metaphor.

### Input:
The book is very interesting.

Correct response:
&gt;&gt; The book is a page-turner.

Model response:
&gt;&gt; The book is a treat.

-------------------------------------
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Above, we see the original model responses</p></li>
<li><p>Note that the goal of DPO is to induce slight style changes; this means we want the model to generate similar but slightly more polite responses</p></li>
<li><p>Before we execute the following code cell that starts the training, here are a few notes about some of the settings:</p></li>
<li><p>we are only passing the parameters of the policy model into the <code class="docutils literal notranslate"><span class="pre">AdamW</span></code> optimizer; that’s the model we want to optimize (we don’t want to modify the reference model)</p></li>
<li><p>we only train for 1 epoch; that’s because DPO is very prone to collapse (the loss might improve, but the model will start generating nonsensical texts)</p></li>
<li><p>in DPO, it’s best to use a very small learning rate</p></li>
<li><p>the beta value can be increased from 0.1 to 0.5 to reduce the effect of DPO (we use 0.1 here to make the results more noticeable)</p></li>
<li><p>The training takes about 2 minutes on an A100 GPU, but it can also be trained in 4 minutes on a smaller L4 GPU; training on a M3 MacBook Air takes about 30 minutes</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>


<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">policy_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">5e-6</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

<span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">tracking</span> <span class="o">=</span> <span class="n">train_model_dpo_simple</span><span class="p">(</span>
    <span class="n">policy_model</span><span class="o">=</span><span class="n">policy_model</span><span class="p">,</span>
    <span class="n">reference_model</span><span class="o">=</span><span class="n">reference_model</span><span class="p">,</span>
    <span class="n">train_loader</span><span class="o">=</span><span class="n">train_loader</span><span class="p">,</span>
    <span class="n">val_loader</span><span class="o">=</span><span class="n">val_loader</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
    <span class="n">num_epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
    <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="c1"># value between 0.1 and 0.5</span>
    <span class="n">eval_freq</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">eval_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">start_context</span><span class="o">=</span><span class="n">format_input</span><span class="p">(</span><span class="n">val_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span>
<span class="p">)</span>

<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">execution_time_minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training completed in </span><span class="si">{</span><span class="n">execution_time_minutes</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> minutes.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ep 1 (Step 000000): Train loss 0.692, Val loss 0.693, Train reward margins 0.019, Val reward margins 0.009
Ep 1 (Step 000005): Train loss 0.690, Val loss 0.691, Train reward margins 0.070, Val reward margins 0.052
Ep 1 (Step 000010): Train loss 0.687, Val loss 0.688, Train reward margins 0.126, Val reward margins 0.108
Ep 1 (Step 000015): Train loss 0.676, Val loss 0.685, Train reward margins 0.362, Val reward margins 0.173
Ep 1 (Step 000020): Train loss 0.676, Val loss 0.680, Train reward margins 0.351, Val reward margins 0.264
Ep 1 (Step 000025): Train loss 0.666, Val loss 0.676, Train reward margins 0.564, Val reward margins 0.359
Ep 1 (Step 000030): Train loss 0.672, Val loss 0.672, Train reward margins 0.456, Val reward margins 0.441
Ep 1 (Step 000035): Train loss 0.663, Val loss 0.669, Train reward margins 0.658, Val reward margins 0.511
Ep 1 (Step 000040): Train loss 0.666, Val loss 0.666, Train reward margins 0.597, Val reward margins 0.574
Ep 1 (Step 000045): Train loss 0.648, Val loss 0.662, Train reward margins 0.982, Val reward margins 0.660
Ep 1 (Step 000050): Train loss 0.648, Val loss 0.659, Train reward margins 0.993, Val reward margins 0.734
Ep 1 (Step 000055): Train loss 0.647, Val loss 0.656, Train reward margins 1.014, Val reward margins 0.799
Ep 1 (Step 000060): Train loss 0.652, Val loss 0.653, Train reward margins 0.893, Val reward margins 0.870
Ep 1 (Step 000065): Train loss 0.631, Val loss 0.650, Train reward margins 1.361, Val reward margins 0.948
Ep 1 (Step 000070): Train loss 0.618, Val loss 0.646, Train reward margins 1.699, Val reward margins 1.038
Ep 1 (Step 000075): Train loss 0.617, Val loss 0.642, Train reward margins 1.733, Val reward margins 1.121
Ep 1 (Step 000080): Train loss 0.592, Val loss 0.639, Train reward margins 2.333, Val reward margins 1.194
Ep 1 (Step 000085): Train loss 0.610, Val loss 0.636, Train reward margins 1.907, Val reward margins 1.275
Ep 1 (Step 000090): Train loss 0.650, Val loss 0.633, Train reward margins 0.964, Val reward margins 1.353
Ep 1 (Step 000095): Train loss 0.607, Val loss 0.630, Train reward margins 1.962, Val reward margins 1.423
Ep 1 (Step 000100): Train loss 0.600, Val loss 0.627, Train reward margins 2.127, Val reward margins 1.500
Ep 1 (Step 000105): Train loss 0.590, Val loss 0.624, Train reward margins 2.458, Val reward margins 1.564
Ep 1 (Step 000110): Train loss 0.607, Val loss 0.622, Train reward margins 1.976, Val reward margins 1.621
Ep 1 (Step 000115): Train loss 0.621, Val loss 0.620, Train reward margins 1.605, Val reward margins 1.682
Below is an instruction that describes a task. Write a response that appropriately completes the request.  ### Instruction: Rewrite the sentence using a metaphor.  ### Input: The book is very interesting.  ### Response: The book is a treat.&lt;|endoftext|&gt;The following is an instruction that describes a task. Write a response that appropriately completes the request.  ### Input: The assignment was written by the student.  ### Response
Training completed in 1.69 minutes.
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>As we can see based on the tracked results above, the loss improves</p></li>
<li><p>Also, the reward margins, which is the difference between the rewards of the chosen and the rejected responses, improve, which is a good sign</p></li>
<li><p>Let’s take a more concrete look at these results in the next section</p></li>
</ul>
<p> </p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="analyzing-the-results">
<h1>6) Analyzing the results<a class="headerlink" href="#analyzing-the-results" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Let’s begin analyzing the results by plotting the DPO loss:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">previous_chapters</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_losses</span>
<span class="c1"># Alternatively:</span>
<span class="c1"># from llms_from_scratch.ch05 import plot_losses</span>


<span class="n">epochs_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;train_losses&quot;</span><span class="p">]))</span>
<span class="n">plot_losses</span><span class="p">(</span>
    <span class="n">epochs_seen</span><span class="o">=</span><span class="n">epochs_tensor</span><span class="p">,</span>
    <span class="n">tokens_seen</span><span class="o">=</span><span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;tokens_seen&quot;</span><span class="p">],</span>
    <span class="n">train_losses</span><span class="o">=</span><span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;train_losses&quot;</span><span class="p">],</span>
    <span class="n">val_losses</span><span class="o">=</span><span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;val_losses&quot;</span><span class="p">],</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;loss&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/9c1babc4db09f1dab32c1cd8ad7ae7406979e645d61d433d82bd84c9d7e0b01b.png" src="../../_images/9c1babc4db09f1dab32c1cd8ad7ae7406979e645d61d433d82bd84c9d7e0b01b.png" />
</div>
</div>
<ul class="simple">
<li><p>As we can see above, the loss continues to improve, which is a good sign</p></li>
<li><p>Based on the downward slope, one might be tempted to train the model a bit further (and readers are encouraged to try this), but note that DPO is prone to collapse, where the model may start generating nonsensical responses</p></li>
<li><p>Next, let’s take a look at the reward margins:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_reward_margins</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;train_chosen_rewards&quot;</span><span class="p">],</span> <span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;train_rejected_rewards&quot;</span><span class="p">])]</span>
<span class="n">val_reward_margins</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;val_chosen_rewards&quot;</span><span class="p">],</span> <span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;val_rejected_rewards&quot;</span><span class="p">])]</span>

<span class="n">plot_losses</span><span class="p">(</span>
    <span class="n">epochs_seen</span><span class="o">=</span><span class="n">epochs_tensor</span><span class="p">,</span>
    <span class="n">tokens_seen</span><span class="o">=</span><span class="n">tracking</span><span class="p">[</span><span class="s2">&quot;tokens_seen&quot;</span><span class="p">],</span>
    <span class="n">train_losses</span><span class="o">=</span><span class="n">train_reward_margins</span><span class="p">,</span>
    <span class="n">val_losses</span><span class="o">=</span><span class="n">val_reward_margins</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;reward margins&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1df3d6872a230ea78d780ca970af2809690abe1d91a71a60f0cce8b7984a1b34.png" src="../../_images/1df3d6872a230ea78d780ca970af2809690abe1d91a71a60f0cce8b7984a1b34.png" />
</div>
</div>
<ul class="simple">
<li><p>As we can see, and as it’s desired, the reward margins improve; this mirrors the loss curve and is a good sign</p></li>
<li><p>Note that DPO losses and reward margins are valuable metrics to track during training; however, they don’t tell the whole story</p></li>
<li><p>Lastly, and most importantly, we have to conduct a qualitative check of the responses</p></li>
<li><p>Here, we will look at the response (in addition, you could use an LLM to score the responses similar to chapter 7)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>


<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">val_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>

    <span class="n">input_text</span> <span class="o">=</span> <span class="n">format_input</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="n">token_ids</span> <span class="o">=</span> <span class="n">generate</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">reference_model</span><span class="p">,</span>
        <span class="n">idx</span><span class="o">=</span><span class="n">text_to_token_ids</span><span class="p">(</span><span class="n">input_text</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">context_size</span><span class="o">=</span><span class="n">BASE_CONFIG</span><span class="p">[</span><span class="s2">&quot;context_length&quot;</span><span class="p">],</span>
        <span class="n">eos_id</span><span class="o">=</span><span class="mi">50256</span>
    <span class="p">)</span>
    <span class="n">generated_text</span> <span class="o">=</span> <span class="n">token_ids_to_text</span><span class="p">(</span><span class="n">token_ids</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
    <span class="n">reference_response_text</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">generated_text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">input_text</span><span class="p">):]</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;### Response:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">token_ids</span> <span class="o">=</span> <span class="n">generate</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">policy_model</span><span class="p">,</span>
        <span class="n">idx</span><span class="o">=</span><span class="n">text_to_token_ids</span><span class="p">(</span><span class="n">input_text</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">context_size</span><span class="o">=</span><span class="n">BASE_CONFIG</span><span class="p">[</span><span class="s2">&quot;context_length&quot;</span><span class="p">],</span>
        <span class="n">eos_id</span><span class="o">=</span><span class="mi">50256</span>
    <span class="p">)</span>
    <span class="n">generated_text</span> <span class="o">=</span> <span class="n">token_ids_to_text</span><span class="p">(</span><span class="n">token_ids</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
    <span class="n">policy_response_text</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">generated_text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">input_text</span><span class="p">):]</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;### Response:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Correct response:</span><span class="se">\n</span><span class="s2">&gt;&gt; </span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reference model response:</span><span class="se">\n</span><span class="s2">&gt;&gt; </span><span class="si">{</span><span class="n">reference_response_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Policy model response:</span><span class="se">\n</span><span class="s2">&gt;&gt; </span><span class="si">{</span><span class="n">policy_response_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Convert the active sentence to passive: &#39;The chef cooks the meal every day.&#39;

Correct response:
&gt;&gt; The meal is cooked by the chef every day.

Reference model response:
&gt;&gt; The meal is cooked every day by the chef.

Policy model response:
&gt;&gt; The meal is prepared by the chef.

-------------------------------------

Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Classify an input string as either a noun or a verb.

### Input:
Dance

Correct response:
&gt;&gt; &#39;Dance&#39; can be classified as a verb.

Reference model response:
&gt;&gt; &quot;Dance&quot; can be classified as a verb.

Policy model response:
&gt;&gt; The input string &quot;Dance&quot; could be classified as a verb.

-------------------------------------

Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Rewrite the sentence using a metaphor.

### Input:
The book is very interesting.

Correct response:
&gt;&gt; The book is a page-turner.

Reference model response:
&gt;&gt; The book is a treat.

Policy model response:
&gt;&gt; The book is a treat.

-------------------------------------
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>As we can see based on the reference model and policy model responses above, the optimized model (i.e., the policy model) indeed slightly changed its style compared to the original model (i.e., reference model)</p></li>
<li><p>For instance, <code class="docutils literal notranslate"><span class="pre">&quot;Dance&quot;</span> <span class="pre">can</span> <span class="pre">be</span> <span class="pre">classified</span> <span class="pre">as</span> <span class="pre">a</span> <span class="pre">verb.</span></code> changed to <code class="docutils literal notranslate"><span class="pre">The</span> <span class="pre">input</span> <span class="pre">string</span> <span class="pre">&quot;Dance&quot;</span> <span class="pre">could</span> <span class="pre">be</span> <span class="pre">classified</span> <span class="pre">as</span> <span class="pre">a</span> <span class="pre">verb.</span></code> which is a slightly more polite response (the use of “could” instead of “can” makes the statement sound less assertive and more tentative)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>


<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>

    <span class="n">input_text</span> <span class="o">=</span> <span class="n">format_input</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="n">token_ids</span> <span class="o">=</span> <span class="n">generate</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">reference_model</span><span class="p">,</span>
        <span class="n">idx</span><span class="o">=</span><span class="n">text_to_token_ids</span><span class="p">(</span><span class="n">input_text</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">context_size</span><span class="o">=</span><span class="n">BASE_CONFIG</span><span class="p">[</span><span class="s2">&quot;context_length&quot;</span><span class="p">],</span>
        <span class="n">eos_id</span><span class="o">=</span><span class="mi">50256</span>
    <span class="p">)</span>
    <span class="n">generated_text</span> <span class="o">=</span> <span class="n">token_ids_to_text</span><span class="p">(</span><span class="n">token_ids</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
    <span class="n">reference_response_text</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">generated_text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">input_text</span><span class="p">):]</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;### Response:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">token_ids</span> <span class="o">=</span> <span class="n">generate</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">policy_model</span><span class="p">,</span>
        <span class="n">idx</span><span class="o">=</span><span class="n">text_to_token_ids</span><span class="p">(</span><span class="n">input_text</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">context_size</span><span class="o">=</span><span class="n">BASE_CONFIG</span><span class="p">[</span><span class="s2">&quot;context_length&quot;</span><span class="p">],</span>
        <span class="n">eos_id</span><span class="o">=</span><span class="mi">50256</span>
    <span class="p">)</span>
    <span class="n">generated_text</span> <span class="o">=</span> <span class="n">token_ids_to_text</span><span class="p">(</span><span class="n">token_ids</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
    <span class="n">policy_response_text</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">generated_text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">input_text</span><span class="p">):]</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;### Response:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">input_text</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Correct response:</span><span class="se">\n</span><span class="s2">&gt;&gt; </span><span class="si">{</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reference model response:</span><span class="se">\n</span><span class="s2">&gt;&gt; </span><span class="si">{</span><span class="n">reference_response_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Policy model response:</span><span class="se">\n</span><span class="s2">&gt;&gt; </span><span class="si">{</span><span class="n">policy_response_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">-------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Rewrite the sentence using a simile.

### Input:
The car is very fast.

Correct response:
&gt;&gt; The car is as fast as lightning.

Reference model response:
&gt;&gt; The car is as fast as a cheetah.

Policy model response:
&gt;&gt; The car is as fast as a cheetah.

-------------------------------------

Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
What type of cloud is typically associated with thunderstorms?

Correct response:
&gt;&gt; The type of cloud typically associated with thunderstorms is cumulonimbus.

Reference model response:
&gt;&gt; A thunderstorm is a type of storm that typically produces thunder or lightning.

Policy model response:
&gt;&gt; The type of cloud typically associated with thunderstorms is a cumulus.

-------------------------------------

Below is an instruction that describes a task. Write a response that appropriately completes the request.

### Instruction:
Name the author of &#39;Pride and Prejudice&#39;.

Correct response:
&gt;&gt; Jane Austen.

Reference model response:
&gt;&gt; The author of &#39;Pride and Prejudice&#39; is Jane Austen.

Policy model response:
&gt;&gt; The author of &#39;Pride and Prejudice&#39; is Jane Austen.

-------------------------------------
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./ch07/04_preference-tuning-with-dpo"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="create-preference-data-ollama.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Generating A Preference Dataset With Llama 3.1 70B And Ollama</p>
      </div>
    </a>
    <a class="right-next"
       href="../05_dataset-generation/README.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Generating Datasets for Instruction Finetuning</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Direct Preference Optimization (DPO) for LLM Alignment (From Scratch)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#a-brief-introduction-to-dpo">1) A brief introduction to DPO</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-a-preference-dataset-for-dpo">2) Preparing a preference dataset for DPO</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-a-preference-dataset">2.1) Loading a preference dataset</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-training-validation-and-test-splits">2.2) Creating training, validation, and test splits</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#developing-a-preferencedataset-class-and-batch-processing-function">2.3) Developing a <code class="docutils literal notranslate"><span class="pre">PreferenceDataset</span></code> class and batch processing function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-training-validation-and-test-set-data-loaders">2.4) Creating training, validation, and test set data loaders</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-a-finetuned-llm-for-dpo-alignment">3) Loading a finetuned LLM for DPO alignment</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#coding-the-dpo-loss-function">4) Coding the DPO Loss Function</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#training-the-model">5) Training the model</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#analyzing-the-results">6) Analyzing the results</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Sebastian Raschka
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>